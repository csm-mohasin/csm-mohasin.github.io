<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚úÖ ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶∞ (‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #0a0a0a;
      color: #fff;
      text-align: center;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #00ffd5;
      margin-bottom: 5px;
      font-weight: 700;
    }
    .status-container {
      background: #111;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 0 15px rgba(0, 255, 213, 0.4);
      max-width: 350px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    .status-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px dashed #333;
    }
    .status-item:last-child {
        border-bottom: none;
    }
    .label {
        color: #00ffd5;
        font-weight: 600;
    }
    .value {
        color: #fff;
    }
    #permission-status {
        font-weight: 600;
        color: #f39c12;
    }
    .error {
        color: #e74c3c !important;
    }
    .success {
        color: #2ecc71 !important;
    }
    .user-id {
        font-size: 14px;
        color: #bbb;
        margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>üìç ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞</h1>
  <p id="user-id" class="user-id">User ID: <span id="display-user-id">Loading...</span></p>
  <p id="permission-status">‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
  
  <div class="status-container">
    <div class="status-item"><span class="label">Status:</span> <span class="value success" id="status-display">Offline</span></div>
    <div class="status-item"><span class="label">Latitude:</span> <span class="value" id="lat">-</span></div>
    <div class="status-item"><span class="label">Longitude:</span> <span class="value" id="lon">-</span></div>
    <div class="status-item"><span class="label">Speed:</span> <span class="value" id="speed">-</span></div>
    <div class="status-item"><span class="label">Battery:</span> <span class="value" id="bat">-</span></div>
    <div class="status-item"><span class="label">Network:</span> <span class="value" id="net">-</span></div>
    <div class="status-item"><span class="label">Last Updated:</span> <span class="value" id="time">-</span></div>
  </div>

  <script type="module">
    // --- 1. DOM Element Caching ---
    const permissionStatusEl = document.getElementById("permission-status");
    const statusDisplayEl = document.getElementById("status-display");
    const latEl = document.getElementById("lat");
    const lonEl = document.getElementById("lon");
    const speedEl = document.getElementById("speed");
    const netEl = document.getElementById("net");
    const batEl = document.getElementById("bat");
    const timeEl = document.getElementById("time");
    const displayUserIdEl = document.getElementById("display-user-id");

    // --- 2. Firebase Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, set, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // **‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£: ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡¶ø‡¶≤ ‡¶∞‡ßá‡¶ñ‡ßá ‡¶è‡¶á ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®**
    // ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® (signup-d32c5)
    const YOUR_FIREBASE_CONFIG = {
        apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4", 
        authDomain:"signup-d32c5.firebaseapp.com",
        projectId:"signup-d32c5",
        databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/",
        // ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡¶≤‡¶æ‡¶Æ
    };

    const app = initializeApp(YOUR_FIREBASE_CONFIG);
    const db = getDatabase(app);

    // --- 3. Persistent User ID Management ---
    const STORAGE_KEY = 'tracker_user_id';
    let USER_ID = localStorage.getItem(STORAGE_KEY);

    if (!USER_ID) {
        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
        USER_ID = 'User-' + Math.random().toString(36).substring(2, 10).toUpperCase();
        localStorage.setItem(STORAGE_KEY, USER_ID);
    }
    displayUserIdEl.textContent = USER_ID;
    
    // Firebase Reference for the current user
    const userRef = ref(db, "users/" + USER_ID);

    // --- 4. Helper Functions ---
    
    async function getBatteryLevel() {
      try {
        if ('getBattery' in navigator) {
            const battery = await navigator.getBattery();
            return (battery.level * 100).toFixed(0) + "%";
        }
        return "N/A";
      } catch (e) {
        return "N/A";
      }
    }

    function getNetworkType() {
      try {
        const net = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        return net ? net.effectiveType.toUpperCase() : "UNKNOWN";
      } catch (e) {
        return "UNKNOWN";
      }
    }

    function updateUI(latitude, longitude, speed, battery, network, timestamp, isLive = true) {
        latEl.textContent = latitude.toFixed(6);
        lonEl.textContent = longitude.toFixed(6);
        speedEl.textContent = speed ? speed.toFixed(2) + " m/s" : "0.00 m/s";
        netEl.textContent = network;
        batEl.textContent = battery;
        timeEl.textContent = timestamp;
        statusDisplayEl.textContent = isLive ? 'LIVE' : 'OFFLINE';
        statusDisplayEl.className = isLive ? 'value success' : 'value error';
    }

    // --- 5. Main Location Handler ---

    /** Sends live location data to Firebase and updates UI. */
    async function locationSuccess(position) {
      const { latitude, longitude, speed, accuracy } = position.coords;
      const battery = await getBatteryLevel();
      const network = getNetworkType();
      const timestamp = new Date().toLocaleTimeString();

      // UI Update
      updateUI(latitude, longitude, speed, battery, network, timestamp, true);
      
      // Data structure:
      const locationData = {
        // LIVE data - these will be deleted on disconnect
        latitude,
        longitude,
        speed: speed ? (speed * 3.6).toFixed(2) : "0.00", // m/s to km/h for admin panel compatibility
        accuracy: accuracy.toFixed(2) + " m",
        
        // STATIC/LAST SEEN data
        battery,
        network,
        time: timestamp,
        timestamp_server: serverTimestamp(),
        
        // LAST SEEN backups - set when online
        last_lat: latitude,
        last_lon: longitude,
        last_time: timestamp,
      };

      // Send to Firebase
      try {
        await set(userRef, locationData);
        permissionStatusEl.textContent = `‚úÖ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá (${timestamp})`;
        permissionStatusEl.classList.remove('error');
        permissionStatusEl.classList.add('success');
      } catch (e) {
        console.error("Firebase Send Error:", e);
        permissionStatusEl.textContent = "‚ö†Ô∏è Firebase-‡¶è ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ (‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®)";
        permissionStatusEl.classList.add('error');
      }
    }

    /** Handles Geolocation API errors. */
    function locationError(error) {
      console.error("Geolocation Error:", error);
      let errorMessage = "‚ùå ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§";
      // (Error message logic similar to previous code)
      
      permissionStatusEl.textContent = errorMessage;
      permissionStatusEl.classList.add('error');
      
      // If location fails, set status to OFFLINE visually
      statusDisplayEl.textContent = 'OFFLINE (GPS Failed)';
      statusDisplayEl.className = 'value error';
    }

    // --- 6. Online/Offline Handling ---
    function setupDisconnect() {
        // ‡¶Ø‡¶ñ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá ‡¶¨‡¶æ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶π‡¶æ‡¶∞‡¶æ‡¶¨‡ßá, ‡¶§‡¶ñ‡¶® ‡¶è‡¶á ‡¶°‡ßá‡¶ü‡¶æ‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§
        onDisconnect(userRef).set({
            // ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶¨‡ßá
            latitude: null,
            longitude: null,
            speed: null,
            
            // last_seen ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
            last_lat: latEl.textContent,
            last_lon: lonEl.textContent,
            last_time: new Date().toLocaleTimeString(),
            battery: batEl.textContent,
            network: netEl.textContent,
            timestamp_server: serverTimestamp(),
        });
    }


    // --- 7. Initialization ---
    window.onload = () => {
      if ("geolocation" in navigator) {
        permissionStatusEl.textContent = "‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        
        // 7.1 Set up onDisconnect handler
        setupDisconnect();
        
        // 7.2 Start continuous position tracking
        navigator.geolocation.watchPosition(locationSuccess, locationError, {
          enableHighAccuracy: true,
          maximumAge: 0, 
          timeout: 15000 
        });
      } else {
        permissionStatusEl.textContent = "‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá Geolocation ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§";
        permissionStatusEl.classList.add('error');
      }
    };
  </script>
</body>
</html>
