<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚úÖ ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶∞ (‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞) | CSM</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #0a0a0a;
      color: #fff;
      text-align: center;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #00ffd5;
      margin-bottom: 5px;
      font-weight: 700;
    }
    .status-container {
      background: #111;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 0 15px rgba(0, 255, 213, 0.4);
      max-width: 350px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    .status-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px dashed #333;
    }
    .status-item:last-child {
        border-bottom: none;
    }
    .label {
        color: #00ffd5;
        font-weight: 600;
    }
    .value {
        color: #fff;
    }
    #permission-status {
        font-weight: 600;
        color: #f39c12;
    }
    .error {
        color: #e74c3c !important;
    }
    .success {
        color: #2ecc71 !important;
    }
    .user-id {
        font-size: 14px;
        color: #bbb;
        margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>üìç ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞</h1>
  <p id="user-id" class="user-id">User ID: <span id="display-user-id">Loading...</span></p>
  <p id="permission-status">‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
  
  <div class="status-container">
    <div class="status-item"><span class="label">Status:</span> <span class="value success" id="status-display">Offline</span></div>
    <div class="status-item"><span class="label">Latitude:</span> <span class="value" id="lat">-</span></div>
    <div class="status-item"><span class="label">Longitude:</span> <span class="value" id="lon">-</span></div>
    <div class="status-item"><span class="label">Speed:</span> <span class="value" id="speed">-</span></div>
    <div class="status-item"><span class="label">Battery:</span> <span class="value" id="bat">-</span></div>
    <div class="status-item"><span class="label">Network:</span> <span class="value" id="net">-</span></div>
    <div class="status-item"><span class="label">Last Updated:</span> <span class="value" id="time">-</span></div>
  </div>

  <script type="module">
    // --- 1. DOM Element Caching ---
    const permissionStatusEl = document.getElementById("permission-status");
    const statusDisplayEl = document.getElementById("status-display");
    const latEl = document.getElementById("lat");
    const lonEl = document.getElementById("lon");
    const speedEl = document.getElementById("speed");
    const netEl = document.getElementById("net");
    const batEl = document.getElementById("bat");
    const timeEl = document.getElementById("time");
    const displayUserIdEl = document.getElementById("display-user-id");

    // --- 2. Firebase Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, set, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // **‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£: ‡¶è‡¶á ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶ï‡¶á ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá**
    const YOUR_FIREBASE_CONFIG = {
        apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4", 
        authDomain:"signup-d32c5.firebaseapp.com",
        projectId:"signup-d32c5",
        databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/",
    };

    const app = initializeApp(YOUR_FIREBASE_CONFIG);
    const db = getDatabase(app);

    // --- 3. Persistent User ID Management (‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶∏‡ßá‡¶≠ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá) ---
    const STORAGE_KEY = 'tracker_user_id';
    let USER_ID = localStorage.getItem(STORAGE_KEY);

    if (!USER_ID) {
        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
        USER_ID = 'User-' + Math.random().toString(36).substring(2, 10).toUpperCase();
        localStorage.setItem(STORAGE_KEY, USER_ID);
    }
    displayUserIdEl.textContent = USER_ID;
    
    // Firebase Reference for the current user
    const userRef = ref(db, "users/" + USER_ID);

    // --- 4. Helper Functions ---
    
    async function getBatteryLevel() {
      try {
        if ('getBattery' in navigator) {
            const battery = await navigator.getBattery();
            return (battery.level * 100).toFixed(0) + "%";
        }
        return "N/A";
      } catch (e) {
        return "N/A";
      }
    }

    function getNetworkType() {
      try {
        const net = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        return net ? net.effectiveType.toUpperCase() : "UNKNOWN";
      } catch (e) {
        return "UNKNOWN";
      }
    }

    function updateUI(latitude, longitude, speed, battery, network, timestamp, isLive = true) {
        latEl.textContent = latitude.toFixed(6);
        lonEl.textContent = longitude.toFixed(6);
        speedEl.textContent = speed ? speed.toFixed(2) + " m/s" : "0.00 m/s";
        netEl.textContent = network;
        batEl.textContent = battery;
        timeEl.textContent = timestamp;
        statusDisplayEl.textContent = isLive ? 'LIVE' : 'OFFLINE';
        statusDisplayEl.className = isLive ? 'value success' : 'value error';
    }

    // --- 5. Main Location Handler ---

    async function locationSuccess(position) {
      const { latitude, longitude, speed, accuracy } = position.coords;
      const battery = await getBatteryLevel();
      const network = getNetworkType();
      const timestamp = new Date().toLocaleTimeString();

      updateUI(latitude, longitude, speed, battery, network, timestamp, true);
      
      // Data structure for Firebase:
      const locationData = {
        // LIVE data (will be null on disconnect)
        latitude,
        longitude,
        speed: speed ? (speed * 3.6).toFixed(2) : "0.00", // m/s to km/h
        accuracy: accuracy.toFixed(2) + " m",
        
        // STATIC/LAST SEEN data
        battery,
        network,
        time: timestamp,
        timestamp_server: serverTimestamp(),
        
        // LAST SEEN backups (used when the user is offline)
        last_lat: latitude,
        last_lon: longitude,
        last_time: timestamp,
      };

      // Send to Firebase
      try {
        await set(userRef, locationData);
        permissionStatusEl.textContent = `‚úÖ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá (${timestamp})`;
        permissionStatusEl.classList.remove('error');
        permissionStatusEl.classList.add('success');
      } catch (e) {
        console.error("Firebase Send Error:", e);
        permissionStatusEl.textContent = "‚ö†Ô∏è Firebase-‡¶è ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ (‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®)";
        permissionStatusEl.classList.add('error');
      }
    }

    function locationError(error) {
      console.error("Geolocation Error:", error);
      let errorMessage = "‚ùå ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§";
      if (error.code === error.PERMISSION_DENIED) {
            errorMessage = "‚ùå ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§";
        } else if (error.code === error.POSITION_UNAVAILABLE) {
            errorMessage = "‚ùå ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§";
        } else if (error.code === error.TIMEOUT) {
            errorMessage = "‚ùå ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∂‡ßá‡¶∑ (Timeout)‡•§";
        }
      
      permissionStatusEl.textContent = errorMessage;
      permissionStatusEl.classList.add('error');
      
      statusDisplayEl.textContent = 'OFFLINE (GPS Failed)';
      statusDisplayEl.className = 'value error';
    }

    // --- 6. Online/Offline Handling ---
    function setupDisconnect() {
        // ‡¶Ø‡¶ñ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá ‡¶¨‡¶æ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶π‡¶æ‡¶∞‡¶æ‡¶¨‡ßá, ‡¶§‡¶ñ‡¶® ‡¶è‡¶á ‡¶°‡ßá‡¶ü‡¶æ‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§
        onDisconnect(userRef).set({
            // Live fields set to null/removed
            latitude: null,
            longitude: null,
            speed: null,
            
            // last_seen data is maintained
            last_lat: latEl.textContent,
            last_lon: lonEl.textContent,
            last_time: new Date().toLocaleTimeString(),
            battery: batEl.textContent,
            network: netEl.textContent,
            timestamp_server: serverTimestamp(),
        });
    }


    // --- 7. Initialization (‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶ö‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï) ---
    window.onload = () => {
      if ("geolocation" in navigator) {
        permissionStatusEl.textContent = "‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        
        // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá getCurrentPosition ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶ö‡¶æ‡¶ì‡ßü‡¶æ
        navigator.geolocation.getCurrentPosition(
          () => {
            permissionStatusEl.textContent = "‚úÖ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            setupDisconnect(); // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ

            // ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶™‡ßá‡¶≤‡ßá watchPosition ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
            navigator.geolocation.watchPosition(locationSuccess, locationError, {
              enableHighAccuracy: true,
              maximumAge: 0, 
              timeout: 15000 
            });
          },
          // ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶®‡¶æ ‡¶™‡ßá‡¶≤‡ßá ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡¶æ ‡¶™‡ßá‡¶≤‡ßá error ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤‡¶æ‡¶∞‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
          locationError, 
          { enableHighAccuracy: true }
        );
      } else {
        permissionStatusEl.textContent = "‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá Geolocation ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§";
        permissionStatusEl.classList.add('error');
      }
    };
  </script>
</body>
</html>
