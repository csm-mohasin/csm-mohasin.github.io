<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Send Live Location</title>

<style>
body {
  font-family: Arial;
  background: #e9f3ff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.card {
  background: #fff;
  padding: 20px;
  width: 350px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.loading {
  font-size: 16px;
  font-weight: bold;
  color:#0a7b0a;
}
</style>
</head>
<body>

<div class="card">
<h2>üìç Sharing Live Location‚Ä¶</h2>
<select id="userSelect" style="padding:10px;width:100%;border-radius:8px;">
  <option value="User1">User 1</option>
  <option value="User2">User 2</option>
  <option value="Admin">Admin ‚úÖ</option>
</select>

<p class="loading" id="status">‚è≥ Getting permission...</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// ‚úÖ Your Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
  authDomain: "signup-d32c5.firebaseapp.com",
  databaseURL: "https://signup-d32c5-default-rtdb.firebaseio.com",
  projectId: "signup-d32c5",
  storageBucket: "signup-d32c5.firebasestorage.app",
  messagingSenderId: "583812949955",
  appId: "1:583812949955:web:fab1bb7be94bc1b4ab3f76",
  measurementId: "G-VLC3QHK8CG"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const statusText = document.getElementById("status");
const userSelect = document.getElementById("userSelect");

// ‚úÖ Battery Check
async function getBatteryLevel() {
  try {
    const b = await navigator.getBattery();
    return Math.round(b.level * 100) + "%";
  } catch {
    return "N/A";
  }
}

// ‚úÖ Network Type
function getNetworkType() {
  return navigator.connection?.effectiveType ?? "unknown";
}

// ‚úÖ Save last location backup
function saveLast(lat, lon) {
  const u = userSelect.value;
  update(ref(db, "users/" + u), {
    last_lat: lat, last_lon: lon, last_time: new Date().toISOString()
  });
}

function sendLocation() {
  navigator.geolocation.watchPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : "0";
    const battery = await getBatteryLevel();
    const network = getNetworkType();
    const u = userSelect.value;

    update(ref(db, "users/" + u), {
      latitude: lat,
      longitude: lon,
      speed: speed,
      battery: battery,
      network: network,
      time: new Date().toISOString()
    });

    saveLast(lat, lon);
    statusText.textContent = `‚úÖ Live: ${lat}, ${lon}`;
  }, 
  err => statusText.textContent = "‚ùå Permission Blocked!", 
  { enableHighAccuracy: true });
}

// ‚úÖ Auto request permission
navigator.geolocation.getCurrentPosition(
  ()=>{ statusText.textContent="‚úÖ Location access granted! Starting..."; sendLocation(); },
  ()=>{ statusText.textContent="‚ùå Enable location to continue!"; }
);

// ‚úÖ Save final location when closing tab
window.addEventListener("beforeunload", () => {
  navigator.geolocation.getCurrentPosition(p => {
    saveLast(p.coords.latitude, p.coords.longitude);
  });
});
</script>
</body>
</html>
