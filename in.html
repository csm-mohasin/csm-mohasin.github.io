<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìç Auto Live Location Sender</title>

<style>
  body {
    font-family: Arial;
    background: #e9f3ff;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin:0;
  }
  .card {
    background: #fff;
    padding: 20px;
    width: 350px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    text-align: center;
  }
  #status { margin-top: 10px; font-size: 14px; font-weight: bold; color:#007bff; }
</style>
</head>
<body>

<div class="card">
  <h2>üìç Auto Live Location</h2>

  <select id="userSelect" style="padding:10px;width:100%;border-radius:8px;margin-bottom:12px;">
    <option value="User1">User 1</option>
    <option value="User2">User 2</option>
    <option value="Admin">Admin ‚úÖ</option>
  </select>

  <p id="status">Waiting for location permission...</p>
</div>

<script type="module">

// ‚úÖ Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// ‚úÖ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
  authDomain: "signup-d32c5.firebaseapp.com",
  databaseURL: "https://signup-d32c5-default-rtdb.firebaseio.com",
  projectId: "signup-d32c5",
  storageBucket: "signup-d32c5.firebasestorage.app",
  messagingSenderId: "583812949955",
  appId: "1:583812949955:web:fab1bb7be94bc1b4ab3f76",
  measurementId: "G-VLC3QHK8CG"
};

// ‚úÖ Init Firebase & vars
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const userSelect = document.getElementById("userSelect");
const statusText = document.getElementById("status");

// üì° Get Network Type (WiFi/4G/5G)
function getNetworkType() {
  if (navigator.connection) {
    return navigator.connection.effectiveType.toUpperCase(); 
  }
  return "UNKNOWN";
}

// üîã Get Battery %
async function getBatteryLevel() {
  if (navigator.getBattery) {
    const b = await navigator.getBattery();
    return Math.round(b.level * 100);
  }
  return "Unknown";
}

// üíæ Save last location before closing
async function saveLast(lat, lon) {
  const user = userSelect.value;
  const battery = await getBatteryLevel();
  const device = navigator.userAgent;
  const network = getNetworkType();

  update(ref(db, "users/" + user), {
    last_lat: lat,
    last_lon: lon,
    last_time: new Date().toISOString(),
    last_battery: battery,
    last_device: device,
    last_network: network
  });
}

// üöÄ Start live tracking
function startLiveTrack() {
  navigator.geolocation.watchPosition(async pos => {

    let lat = pos.coords.latitude;
    let lon = pos.coords.longitude;
    const user = userSelect.value;
    const battery = await getBatteryLevel();
    const device = navigator.userAgent;
    const network = getNetworkType();

    update(ref(db, "users/" + user), {
      latitude: lat,
      longitude: lon,
      battery: battery,
      device: device,
      network: network,
      time: new Date().toISOString()
    });

    saveLast(lat, lon);

    statusText.textContent = "‚úÖ Sending Live Location...";
  }, 
  err => {
    statusText.textContent = "‚ùå Please allow location!";
  }, 
  { enableHighAccuracy: true });
}

// üìç Auto ask permission on load
window.onload = () => {
  statusText.textContent = "‚è≥ Asking location permission...";
  navigator.geolocation.getCurrentPosition(
    () => startLiveTrack(),
    () => statusText.textContent = "‚ùå Allow location to continue"
  );
};

// üîö Save last location when user exits
window.addEventListener("beforeunload", () => {
  navigator.geolocation.getCurrentPosition(pos => {
    saveLast(pos.coords.latitude, pos.coords.longitude);
  });
});
</script>

</body>
</html>
