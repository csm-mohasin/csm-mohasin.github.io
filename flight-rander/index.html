<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSM Live Radar | Dynamic Sync</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #050505; color: #00f3ff; font-family: 'Share Tech Mono', monospace; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #050505; }

        /* Glass Panel UI */
        .glass-panel {
            position: absolute;
            top: 20px; left: 20px; z-index: 1000;
            background: rgba(10, 20, 30, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #ff1493;
            padding: 15px; border-radius: 4px;
            width: 240px; box-shadow: 0 0 20px rgba(255, 20, 147, 0.3);
        }

        .header-title { font-size: 16px; color: #ff1493; border-bottom: 1px solid #ff1493; margin-bottom: 10px; padding-bottom: 5px; font-weight: bold; letter-spacing: 1px; }
        .stat { font-size: 12px; margin-bottom: 5px; }
        .dev-tag { margin-top: 10px; font-size: 10px; color: #facc15; border-top: 1px solid #333; padding-top: 5px; text-align: center; }

        /* Marker & Popup Styles */
        .leaflet-marker-icon { transition: transform 1s linear !important; }
        .leaflet-popup-content-wrapper { background: #111 !important; color: #ff1493 !important; border: 1px solid #ff1493; border-radius: 2px; }
        .leaflet-popup-tip { background: #ff1493 !important; }
        
        .info-table { width: 100%; font-size: 11px; margin-top: 5px; }
        .info-table td { padding: 2px 0; border-bottom: 1px solid rgba(255, 20, 147, 0.1); }
        .val { color: #fff; text-align: right; font-weight: bold; }

        /* Layer Control Customization */
        .leaflet-control-layers { background: rgba(10, 20, 30, 0.9) !important; color: #00f3ff !important; border: 1px solid #00f3ff !important; }
    </style>
</head>
<body>

    <div class="glass-panel">
        <div class="header-title">CSM SKY RADAR</div>
        <div class="stat" id="status">STATUS: LOADING...</div>
        <div class="stat" id="count">AIRCRAFT: 0</div>
        <div class="stat" id="url-info">SYNC: ACTIVE</div>
        <div class="dev-tag">ENGINEER: CSM MOHASIN ALAM</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let map, planeLayer, pathLayer;
        let activePlanes = {}; 
        const PINK = "#ff1493";

        // ১. URL থেকে লোকেশন রিড করার ফাংশন
        function getCoordsFromURL() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const parts = hash.split(',');
                if (parts.length === 3) {
                    return { lat: parseFloat(parts[0]), lon: parseFloat(parts[1]), zoom: parseInt(parts[2]) };
                }
            }
            return null;
        }

        // ২. URL আপডেট করার ফাংশন
        function updateURL() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            const hash = `#${center.lat.toFixed(4)},${center.lng.toFixed(4)},${zoom}`;
            window.history.replaceState(null, null, hash);
        }

        // ৩. রাডার ম্যাপ ইনিশিয়ালাইজেশন
        async function initRadar(lat, lon, zoom = 9) {
            const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
            const satelliteMap = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}');
            const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

            map = L.map('map', { 
                zoomControl: true, 
                layers: [darkMap], 
                attributionControl: false 
            }).setView([lat, lon], zoom);

            // লেয়ার কন্ট্রোল
            const baseMaps = {
                "<span style='color:#00f3ff'>DARK MODE</span>": darkMap,
                "<span style='color:#00f3ff'>SATELLITE</span>": satelliteMap,
                "<span style='color:#00f3ff'>STREET</span>": streetMap
            };
            L.control.layers(baseMaps, null, { collapsed: false }).addTo(map);

            planeLayer = L.layerGroup().addTo(map);
            pathLayer = L.layerGroup().addTo(map);

            // ম্যাপ মুভ করলে URL আপডেট হবে
            map.on('moveend', updateURL);
            map.on('zoomend', updateURL);

            updateRadar();
            setInterval(updateRadar, 12000); 
            setInterval(predictAndTrail, 1000); 
            
            document.getElementById('status').innerText = "STATUS: ONLINE";
        }

        // ৪. ডেটা ফেচিং (ম্যাপের সেন্টার অনুযায়ী)
        async function updateRadar() {
            const center = map.getCenter();
            const r = 2.5; 
            const url = `https://opensky-network.org/api/states/all?lamin=${center.lat-r}&lamax=${center.lat+r}&lomin=${center.lng-r}&lomax=${center.lng+r}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                const states = data.states || [];
                document.getElementById('count').innerText = `AIRCRAFT: ${states.length} DETECTED`;
                syncPlanes(states);
            } catch (e) { 
                console.log("Syncing...");
            }
        }

        function syncPlanes(states) {
            const currentIds = new Set();
            states.forEach(s => {
                const [icao, callsign, origin, , , lon, lat, alt, , vel, track] = s;
                if (!lat || !lon) return;
                currentIds.add(icao);

                const planeHtml = `<div style="transform: rotate(${(track || 0) - 45}deg);">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="${PINK}">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                </div>`;

                const popupHtml = `
                    <div style="min-width:150px">
                        <b>FLIGHT: ${callsign || 'N/A'}</b>
                        <table class="info-table">
                            <tr><td style="color:#888">ORIGIN</td><td class="val">${origin}</td></tr>
                            <tr><td style="color:#888">SPEED</td><td class="val">${Math.round(vel*3.6)} km/h</td></tr>
                            <tr><td style="color:#888">ALT</td><td class="val">${Math.round(alt || 0)} m</td></tr>
                        </table>
                    </div>
                `;

                if (activePlanes[icao]) {
                    activePlanes[icao].marker.setLatLng([lat, lon]);
                    activePlanes[icao].marker.getPopup().setContent(popupHtml);
                    activePlanes[icao].data = { lat, lon, vel, track };
                } else {
                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({ html: planeHtml, iconSize: [26, 26], className: '' })
                    }).addTo(planeLayer);

                    const polyline = L.polyline([], {color: PINK, weight: 2, opacity: 0.6, dashArray: '5, 10'}).addTo(pathLayer);
                    marker.bindPopup(popupHtml);
                    activePlanes[icao] = { marker, polyline, history: [[lat, lon]], data: { lat, lon, vel, track } };
                }
            });

            for (let id in activePlanes) {
                if (!currentIds.has(id)) {
                    pathLayer.removeLayer(activePlanes[id].polyline);
                    planeLayer.removeLayer(activePlanes[id].marker);
                    delete activePlanes[id];
                }
            }
        }

        function predictAndTrail() {
            for (let id in activePlanes) {
                const p = activePlanes[id];
                if (!p.data.vel) continue;

                const speedInDeg = p.data.vel / 111111; 
                const angleRad = (p.data.track - 90) * (Math.PI / 180);
                const newLat = p.data.lat + (speedInDeg * Math.sin(-angleRad));
                const newLon = p.data.lon + (speedInDeg * Math.cos(angleRad));

                p.marker.setLatLng([newLat, newLon]);
                p.data.lat = newLat;
                p.data.lon = newLon;

                p.history.push([newLat, newLon]);
                if (p.history.length > 20) p.history.shift();
                p.polyline.setLatLngs(p.history);
            }
        }

        // ৫. ম্যাপ স্টার্ট লজিক
        window.onload = () => {
            const urlData = getCoordsFromURL();
            if (urlData) {
                initRadar(urlData.lat, urlData.lon, urlData.zoom);
            } else {
                navigator.geolocation.getCurrentPosition(
                    p => initRadar(p.coords.latitude, p.coords.longitude),
                    () => initRadar(23.81, 90.41) // Default Dhaka
                );
            }
        };
    </script>
</body>
</html>
