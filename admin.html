<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin â€” Live User Locations</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{font-family:Arial;background:#f4f6fc;padding:20px}
h2{text-align:center}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:14px}
th{background:#007bff;color:#fff}
#map{height:380px;margin-top:20px;border-radius:10px}
</style>
</head>
<body>

<h2>Admin Panel â€” Live User Locations</h2>
<table>
<tr>
<th>User</th>
<th>Latitude</th>
<th>Longitude</th>
<th>Battery</th>
<th>IP</th>
<th>Time</th>
</tr>
<tbody id="usersTable"></tbody>
</table>

<div id="map" style="display:none;"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import {getAuth,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
import {getFirestore,collection,getDocs} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
  authDomain: "signup-d32c5.firebaseapp.com",
  projectId: "signup-d32c5",
  storageBucket: "signup-d32c5.firebasestorage.app",
  messagingSenderId: "583812949955",
  appId: "1:583812949955:web:fab1bb7be94bc1b4ab3f76"
};

const ADMIN = "csmmohasinalam@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let map, marker;

async function loadUsers(){
  const body=document.getElementById("usersTable");
  body.innerHTML="Loading...";

  let snap = await getDocs(collection(db,"users"));
  body.innerHTML="";

  snap.forEach(d=>{
    let u=d.data();
    body.innerHTML+=`
    <tr>
      <td>${u.email}</td>
      <td>${u.latitude ?? "â€”"}</td>
      <td>${u.longitude ?? "â€”"}</td>
      <td>${u.battery?u.battery+"%":"â€”"}</td>
      <td>${u.ip ?? "â€”"}</td>
      <td>${u.time ?? "â€”"}</td>
    </tr>`;

    if(u.latitude && u.longitude) showMap(u.latitude,u.longitude);
  });
}

function showMap(lat,lng){
  document.getElementById("map").style.display="block";
  if(!map){
    map=L.map('map').setView([lat,lng],14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  }
  if(marker) marker.remove();
  marker=L.marker([lat,lng]).addTo(map);
}

onAuthStateChanged(auth,user=>{
  if(!user || user.email!==ADMIN){
    document.body.innerHTML="<h2>ðŸš« Access Denied</h2>";
    return;
  }
  loadUsers();
});
</script>
</body>
</html>
