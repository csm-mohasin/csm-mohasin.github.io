<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìç Live Location (User)</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #eef5ff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
}
.card {
  background: white;
  padding: 25px;
  width: 340px;
  border-radius: 14px;
  text-align: center;
  box-shadow: 0 6px 15px rgba(0,0,0,0.15);
}
h2 {
  color: #007bff;
  margin-bottom: 15px;
}
p {
  font-size: 15px;
  color: #333;
}
#status {
  font-weight: bold;
  color: green;
  margin-top: 10px;
}
#user-id {
  font-size: 12px;
  color: #666;
  margin-top: 10px;
  word-break: break-all;
}
</style>
</head>
<body>

<div class="card">
  <h2>üì° Live Location Sharing</h2>
  <p id="status">‚è≥ Waiting for location permission...</p>
  <p id="user-id">User ID: Generating...</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// üî• Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
  authDomain: "signup-d32c5.firebaseapp.com",
  databaseURL: "https://signup-d32c5-default-rtdb.firebaseio.com",
  projectId: "signup-d32c5",
  storageBucket: "signup-d32c5.firebasestorage.app",
  messagingSenderId: "583812949955",
  appId: "1:583812949955:web:fab1bb7be94bc1b4ab3f76"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const statusEl = document.getElementById("status");
const userIdEl = document.getElementById("user-id");
const USER_ID_KEY = "live_location_user_id";
let UNIQUE_ID;

// üîπ Unique ID ‡¶§‡ßà‡¶∞‡¶ø / ‡¶≤‡ßã‡¶°
function getOrCreateId() {
  let id = localStorage.getItem(USER_ID_KEY);
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem(USER_ID_KEY, id);
  }
  userIdEl.textContent = `User ID: ${id.substring(0, 8)}...`;
  return id;
}
UNIQUE_ID = getOrCreateId();

// üîπ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® Firebase ‡¶è ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
async function sendToFirebase(lat, lon) {
  try {
    await update(ref(db, "users/" + UNIQUE_ID), {
      latitude: lat,
      longitude: lon,
      time: new Date().toISOString()
    });
    statusEl.textContent = `‚úÖ Location updated: (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
  } catch (e) {
    statusEl.textContent = "‚ö†Ô∏è Failed to send location.";
    console.error(e);
  }
}

// üîπ Error Handle
function handleError(err) {
  console.error("Location Error:", err);
  if (err.code === 1) {
    statusEl.textContent = "‚ùå Permission denied! Please allow location.";
  } else if (err.code === 2) {
    statusEl.textContent = "‚ö†Ô∏è Location unavailable!";
  } else if (err.code === 3) {
    statusEl.textContent = "‚è≥ Request timed out!";
  } else {
    statusEl.textContent = "‚ùå Unknown error occurred.";
  }
}

// üîπ ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶§‡ßá‡¶á ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶ö‡¶æ‡¶ì‡ßü‡¶æ
window.onload = () => {
  if (!("geolocation" in navigator)) {
    statusEl.textContent = "‚ùå Geolocation not supported in this browser.";
    return;
  }

  // üëâ Permission popup trigger
  navigator.geolocation.getCurrentPosition(
    pos => {
      statusEl.textContent = "‚úÖ Permission granted! Starting tracking...";
      startTracking();
    },
    err => handleError(err),
    { enableHighAccuracy: true, timeout: 10000 }
  );
};

// üîπ Live tracking ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ
function startTracking() {
  navigator.geolocation.watchPosition(
    pos => {
      sendToFirebase(pos.coords.latitude, pos.coords.longitude);
    },
    err => handleError(err),
    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
  );
}

// üîπ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶¨‡¶®‡ßç‡¶ß‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶≠
window.addEventListener("beforeunload", () => {
  navigator.geolocation.getCurrentPosition(p => {
    sendToFirebase(p.coords.latitude, p.coords.longitude);
  });
});
</script>
</body>
</html>
