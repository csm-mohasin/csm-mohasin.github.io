<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CSM | Neural Pro V3.1 Optimized</title>
    <style>
        :root {
            --neon-cyan: #00f2ff;
            --neon-green: #39ff14;
            --bg-dark: #080808;
            --panel-bg: #121212;
            --hacker-glow: rgba(0, 242, 255, 0.3);
        }

        body, html {
            margin: 0; padding: 0;
            background: var(--bg-dark);
            color: #fff;
            font-family: 'Fira Code', monospace;
            height: 100dvh; width: 100vw;
            overflow: hidden; touch-action: none;
        }

        .main-container { display: flex; flex-direction: column; height: 100dvh; }

        .header {
            background: var(--panel-bg);
            padding: 8px 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--neon-cyan);
            z-index: 20;
        }

        .logo { color: var(--neon-cyan); font-weight: bold; font-size: 0.75rem; letter-spacing: 1px; }

        #searchPopup {
            position: fixed;
            top: 100px; left: 50%;
            transform: translateX(-50%);
            width: 260px;
            background: rgba(18, 18, 18, 0.98);
            border: 2px solid var(--neon-cyan);
            padding: 12px;
            z-index: 10005;
            display: none;
            border-radius: 10px;
            box-shadow: 0 0 20px var(--hacker-glow);
            touch-action: none;
        }

        .popup-header {
            font-size: 0.5rem; color: var(--neon-cyan);
            margin-bottom: 8px; text-align: center;
            cursor: move; padding: 4px; border-bottom: 1px solid #333;
        }

        .popup-input {
            width: 100%; background: #000;
            border: 1px solid #333; color: var(--neon-cyan);
            padding: 6px; margin-bottom: 6px;
            border-radius: 4px; font-size: 0.7rem; box-sizing: border-box;
        }

        .workspace { display: flex; flex: 1; position: relative; background: #000; overflow: hidden; }
        .panel-editor { width: 50%; display: flex; flex-direction: column; background: var(--panel-bg); position: relative; }
        .panel-preview { flex: 1; display: flex; flex-direction: column; background: #fff; }

        #editor-wrapper { position: relative; flex: 1; overflow: hidden; }

        /* Performance Fix: Highlight layer off by default */
        #highlight-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            padding: 10px; box-sizing: border-box;
            pointer-events: none; 
            white-space: pre-wrap; word-wrap: break-word;
            font-size: 13px; line-height: 1.4; font-family: 'Fira Code', monospace;
            z-index: 1;
            display: none; /* Only show when searching */
        }

        .search-match { background: rgba(255, 255, 0, 0.6); color: #000; border-radius: 2px; }

        textarea {
            width: 100%; height: 100%;
            padding: 10px; font-size: 13px; line-height: 1.4;
            font-family: 'Fira Code', monospace;
            background: transparent; 
            color: #d4d4d4;
            border: none; outline: none; resize: none;
            position: relative; z-index: 2;
            caret-color: var(--neon-cyan);
        }

        /* When searching, make textarea text transparent */
        .searching textarea { color: transparent; }
        .searching #highlight-layer { display: block; }

        iframe { flex: 1; border: none; background: #fff; width: 100%; }

        /* Symbol Bar */
        .symbol-bar {
            background: #1a1a1a; display: flex; gap: 4px; padding: 6px;
            overflow-x: auto; border-top: 1px solid #333; scrollbar-width: none;
        }
        .sym-btn {
            background: #252525; color: var(--neon-cyan);
            border: 1px solid #444; padding: 6px 11px;
            border-radius: 3px; font-size: 0.75rem; flex-shrink: 0;
        }

        #suggestion-box {
            position: fixed; background: #1a1a1a; border: 1px solid var(--neon-cyan);
            max-height: 140px; overflow-y: auto; display: none; z-index: 10001;
            border-radius: 4px; min-width: 130px;
        }
        .suggestion-item { padding: 8px 10px; font-size: 11px; color: #ccc; border-bottom: 1px solid #222; }
        .suggestion-item.active { background: var(--neon-cyan); color: #000; }

        #resizer {
            width: 15px; cursor: col-resize; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center;
            border-left: 1px solid #333; z-index: 10; touch-action: none;
        }
        #resizer::after { content: "‚ãÆ"; color: var(--neon-cyan); }

        .btn {
            background: transparent; border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan); padding: 4px 8px; font-size: 0.6rem;
            cursor: pointer; border-radius: 3px;
        }
        .btn-active { border-color: var(--neon-green); color: var(--neon-green); }
        .resizing iframe { pointer-events: none; }
        
        .option-row { display: flex; align-items: center; gap: 5px; font-size: 0.6rem; color: var(--neon-cyan); margin-bottom: 8px; }
    </style>
</head>
<body>

<input type="file" id="fileInput" accept=".html,.css,.js" style="display:none">
<input type="color" id="colorPicker" style="visibility:hidden; position:absolute;">

<div id="searchPopup">
    <div class="popup-header" id="popupHeader">DRAG ‚Ä¢ SEARCH_UNIT</div>
    <input type="text" id="findInput" class="popup-input" placeholder="Find..." oninput="applyHackerHighlight()">
    <div class="option-row">
        <input type="checkbox" id="caseSensitive" onchange="applyHackerHighlight()"> 
        <label for="caseSensitive">Case Sensitive</label>
    </div>
    <input type="text" id="replaceInput" class="popup-input" placeholder="Replace with...">
    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
        <button class="btn" style="flex:1" onclick="findNext()">NEXT</button>
        <button class="btn" style="flex:1" onclick="doReplace()">REPLACE</button>
        <button class="btn" style="width:100%; border-color:#ff4444; color:#ff4444; margin-top:4px;" onclick="togglePopup()">CLOSE</button>
    </div>
</div>

<div id="suggestion-box"></div>
<div id="cursor-measurer" style="position:absolute; visibility:hidden; white-space:pre-wrap; font-family:'Fira Code'; font-size:13px;"></div>

<div class="main-container">
    <div class="header">
        <div class="logo">CSM_V3.1_PRO</div>
        <div style="display: flex; gap: 4px;">
            <button class="btn" onclick="undo()">‚ü≤</button>
            <button class="btn" onclick="redo()">‚ü≥</button>
            <button class="btn btn-active" id="wrapBtn" onclick="toggleWrap()">W</button>
            <button class="btn" onclick="togglePopup()">üîç</button>
            <button class="btn" onclick="pickColor()">üé®</button>
            <button class="btn" onclick="openFile()">üìÇ</button>
            <button class="btn" onclick="downloadCode()">SAVE</button>
        </div>
    </div>

    <div class="workspace" id="container">
        <div class="panel-editor" id="editorSide">
            <div id="editor-wrapper">
                <div id="highlight-layer"></div>
                <textarea id="codeInput" spellcheck="false" style="white-space: pre-wrap;" onscroll="syncScroll()" oninput="handleInput()"></textarea>
            </div>
            <div class="symbol-bar">
                <button class="sym-btn" onclick="insertChar('<')">&lt;</button>
                <button class="sym-btn" onclick="insertChar('>')">&gt;</button>
                <button class="sym-btn" onclick="insertChar('/')">/</button>
                <button class="sym-btn" onclick="insertChar('=')">=</button>
                <button class="sym-btn" onclick="insertChar('\"')">"</button>
                <button class="sym-btn" onclick="insertChar(' ')">SP</button>
                <button class="sym-btn" onclick="insertChar('{')">{</button>
                <button class="sym-btn" onclick="insertChar('}')">}</button>
                <button class="sym-btn" onclick="insertChar(';')">;</button>
            </div>
        </div>
        <div id="resizer"></div>
        <div class="panel-preview" id="previewSide">
            <iframe id="livePreview"></iframe>
        </div>
    </div>
</div>

<script>
    const codeInput = document.getElementById('codeInput');
    const highlightLayer = document.getElementById('highlight-layer');
    const livePreview = document.getElementById('livePreview');
    const editorSide = document.getElementById('editorSide');
    const resizer = document.getElementById('resizer');
    const searchPopup = document.getElementById('searchPopup');
    const suggestionBox = document.getElementById('suggestion-box');
    const measurer = document.getElementById('cursor-measurer');
    const editorWrapper = document.getElementById('editor-wrapper');

    let history = [""];
    let historyStep = 0;
    let previewTimeout;

    function saveState() {
        if (codeInput.value === history[historyStep]) return;
        history = history.slice(0, historyStep + 1);
        history.push(codeInput.value);
        if (history.length > 30) history.shift(); else historyStep++;
    }

    function undo() { if (historyStep > 0) { historyStep--; codeInput.value = history[historyStep]; updatePreview(false); } }
    function redo() { if (historyStep < history.length - 1) { historyStep++; codeInput.value = history[historyStep]; updatePreview(false); } }

    // Optimization: Debounced Preview update
    function handleInput() {
        clearTimeout(previewTimeout);
        previewTimeout = setTimeout(() => {
            updatePreview(true);
        }, 500); // Wait 500ms after typing stops
    }

    function updatePreview(save = true) {
        const doc = livePreview.contentDocument;
        doc.open(); doc.write(codeInput.value); doc.close();
        if (save) saveState();
    }

    function applyHackerHighlight() {
        const find = document.getElementById('findInput').value;
        if (!find || find.length < 2) { 
            editorWrapper.classList.remove('searching');
            highlightLayer.innerHTML = ""; 
            return; 
        }

        editorWrapper.classList.add('searching');
        const text = codeInput.value;
        const isCase = document.getElementById('caseSensitive').checked;
        const flags = isCase ? 'g' : 'gi';
        
        // Performance fix: Escape HTML only when needed
        const escapedText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const regex = new RegExp(find.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), flags);
        
        highlightLayer.innerHTML = escapedText.replace(regex, m => `<span class="search-match">${m}</span>`);
        syncScroll();
    }

    function syncScroll() { 
        if (editorWrapper.classList.contains('searching')) {
            highlightLayer.scrollTop = codeInput.scrollTop; 
            highlightLayer.scrollLeft = codeInput.scrollLeft; 
        }
    }

    // Modal Drag
    let isDragging = false, offset = [0, 0];
    document.getElementById('popupHeader').addEventListener('touchstart', (e) => {
        isDragging = true;
        const t = e.touches[0];
        offset = [searchPopup.offsetLeft - t.clientX, searchPopup.offsetTop - t.clientY];
    });
    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const t = e.touches[0];
        searchPopup.style.left = (t.clientX + offset[0]) + 'px';
        searchPopup.style.top = (t.clientY + offset[1]) + 'px';
        searchPopup.style.transform = 'none';
    });
    document.addEventListener('touchend', () => isDragging = false);

    function togglePopup() { 
        const isVisible = searchPopup.style.display === 'block';
        searchPopup.style.display = isVisible ? 'none' : 'block'; 
        if (isVisible) {
            editorWrapper.classList.remove('searching');
            highlightLayer.innerHTML = "";
        }
    }

    function toggleWrap() {
        const isWrapped = codeInput.style.whiteSpace === 'pre-wrap';
        codeInput.style.whiteSpace = isWrapped ? 'pre' : 'pre-wrap';
        highlightLayer.style.whiteSpace = isWrapped ? 'pre' : 'pre-wrap';
        document.getElementById('wrapBtn').classList.toggle('btn-active');
    }

    function insertChar(c) {
        const s = codeInput.selectionStart, e = codeInput.selectionEnd;
        codeInput.value = codeInput.value.substring(0, s) + c + codeInput.value.substring(e);
        codeInput.selectionStart = codeInput.selectionEnd = s + c.length;
        codeInput.focus(); handleInput();
    }

    function findNext() {
        const find = document.getElementById('findInput').value;
        if (!find) return;
        const text = codeInput.value;
        const isCase = document.getElementById('caseSensitive').checked;
        const searchText = isCase ? text : text.toLowerCase();
        const searchFind = isCase ? find : find.toLowerCase();
        let nextIdx = searchText.indexOf(searchFind, codeInput.selectionEnd);
        if (nextIdx === -1) nextIdx = searchText.indexOf(searchFind, 0);
        if (nextIdx !== -1) {
            codeInput.focus();
            codeInput.setSelectionRange(nextIdx, nextIdx + find.length);
        }
    }

    function doReplace() {
        const f = document.getElementById('findInput').value;
        const r = document.getElementById('replaceInput').value;
        if(f) {
            const regex = new RegExp(f.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
            codeInput.value = codeInput.value.replace(regex, r);
            updatePreview(true);
        }
    }

    // Resizer logic
    let resizing = false;
    resizer.addEventListener('touchstart', () => { resizing = true; document.body.classList.add('resizing'); });
    document.addEventListener('touchmove', (e) => {
        if (!resizing) return;
        let x = e.touches[0].clientX;
        let p = (x / window.innerWidth) * 100;
        if (p > 5 && p < 95) editorSide.style.width = p + '%';
    });
    document.addEventListener('touchend', () => { resizing = false; document.body.classList.remove('resizing'); });

    function openFile() { document.getElementById('fileInput').click(); }
    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => { codeInput.value = ev.target.result; updatePreview(true); };
        reader.readAsText(e.target.files[0]);
    };
    function downloadCode() {
        const blob = new Blob([codeInput.value], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = 'project.html'; a.click();
    }

    window.onload = () => updatePreview(false);
</script>
</body>
</html>
