<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üöö Multi-User Delivery Tracking</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
body {
  margin:0;
  font-family:Arial;
  background:#eef5ff;
}
header {
  padding:12px;
  background:#0056d2;
  color:#fff;
  font-size:20px;
  font-weight:bold;
  text-align:center;
}
#map{
  height:65vh;
  margin:10px;
  border-radius:10px;
  overflow:hidden;
}
.info-box {
  padding:10px 15px;
  font-size:15px;
}

.btn {
  width:90%;
  margin:6px auto;
  padding:14px;
  display:block;
  font-size:16px;
  border-radius:8px;
  border:none;
  font-weight:bold;
}
.show-btn{background:#007bff;color:white;}
.clear-btn{background:#d9534f;color:white;}

/* Custom Dropdown */
.dropdown {
  width:90%;
  margin:10px auto;
  background:#ffffff;
  border:2px solid #007bff;
  border-radius:10px;
  padding:12px;
  font-size:17px;
  font-weight:600;
  position:relative;
  cursor:pointer;
}
.dropdown-selected {color:#212529;}
.dropdown-list {
  display:none;
  position:absolute;
  top:55px;
  left:0;
  width:100%;
  background:white;
  border:1px solid #007bff;
  border-radius:10px;
  box-shadow:0 6px 20px rgba(0,0,0,0.1);
  max-height:250px;
  overflow-y:auto;
  z-index:999;
}
.dropdown-item {
  padding:12px;
  font-size:16px;
  border-bottom:1px solid #eee;
}
.dropdown-item:hover {
  background:#eef5ff;
  font-weight:600;
}

/* Map switch button */
.toggle-map{
  position:absolute;
  top:80px;
  right:10px;
  padding:8px;
  background:#fff;
  border-radius:6px;
  border:1px solid #ccc;
  z-index:9999;
  font-size:14px;
}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
 authDomain:"signup-d32c5.firebaseapp.com",
 projectId:"signup-d32c5",
 storageBucket:"signup-d32c5.firebasestorage.app",
 messagingSenderId:"583812949955",
 appId:"1:583812949955:web:fab1bb7be94bc1b4ab3f76",
 databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>

<body>

<header>üìç Multi-User Delivery Tracking</header>

<div class="info-box">
Distance: <b id="dist">--</b> km<br>
ETA: <b id="eta">--</b> mins
</div>

<!-- Custom Dropdown -->
<div class="dropdown">
  <div class="dropdown-selected" id="selectedUser">Select Customer</div>
  <div class="dropdown-list" id="dropdownList"></div>
</div>

<div id="map"></div>

<button class="btn show-btn" onclick="drawRoute()">Show Route üöóüìç</button>
<button class="btn clear-btn" onclick="clearRoute()">Clear Route ‚ùå</button>

<button class="toggle-map" onclick="toggleMap()">üõ∞Ô∏è Satellite</button>

<script>

// ----- Map Setup -----
let map = L.map("map").setView([23.8103, 90.4125], 13);

let normalMap = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
let satelliteMap = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
  subdomains:['mt0','mt1','mt2','mt3']
});
normalMap.addTo(map);

let isSatellite=false;
function toggleMap(){
  if(isSatellite){
    map.removeLayer(satelliteMap);
    normalMap.addTo(map);
  } else {
    map.removeLayer(normalMap);
    satelliteMap.addTo(map);
  }
  isSatellite=!isSatellite;
}

// ----- Variables -----
let myLat, myLon, myMarker, customerMarker, route;
let activeUser = null;
let allUsers=[];

// ----- Admin GPS -----
navigator.geolocation.watchPosition(p=>{
  myLat=p.coords.latitude;
  myLon=p.coords.longitude;

  if(!myMarker){
    myMarker=L.marker([myLat,myLon],{
      icon:L.icon({iconUrl:"https://www.gstatic.com/mapspro/images/stock/503-wht-circle.png", iconSize:[15,15]})
    }).addTo(map);
  }
  myMarker.setLatLng([myLat,myLon]);
});

// ----- Dropdown Logic -----
const dropdown = document.querySelector('.dropdown');
const dropdownList = document.getElementById('dropdownList');
const selectedUser = document.getElementById('selectedUser');

dropdown.onclick = ()=> dropdownList.style.display =
 dropdownList.style.display==="block"?"none":"block";

function renderUsers(){
 dropdownList.innerHTML="";
 allUsers.forEach(uid=>{
   let div=document.createElement("div");
   div.className="dropdown-item";
   div.innerText=uid;
   div.onclick=()=>{
     activeUser=uid;
     selectedUser.innerText=uid;
     dropdownList.style.display="none";
     loadUser(uid);
   }
   dropdownList.appendChild(div);
 });
}

// ----- Load Firebase users -----
firebase.database().ref("users").on("value",snap=>{
 allUsers=Object.keys(snap.val()||{});
 renderUsers();
});

// ----- Load Customer Location -----
function loadUser(uid){
 firebase.database().ref("users/"+uid).on("value",snap=>{
   let u=snap.val();
   if(!u) return;
   let lat=u.lat, lon=u.lon;

   if(!customerMarker){
     customerMarker=L.marker([lat,lon],{
       icon:L.icon({iconUrl:"https://www.google.com/mapfiles/ms/icons/red-dot.png"})
     }).addTo(map);
   }
   customerMarker.setLatLng([lat,lon]);

   if(myLat && myLon) calcDistance(lat,lon);
 });
}

// ----- Distance -----
function calcDistance(a,b){
 let R=6371;
 let dLat=(a-myLat)*Math.PI/180;
 let dLon=(b-myLon)*Math.PI/180;
 let x=Math.sin(dLat/2)**2 + Math.cos(myLat*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(dLon/2)**2;
 let d=R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
 document.getElementById("dist").innerText=d.toFixed(2);
 document.getElementById("eta").innerText=Math.round((d/30)*60);
}

// ----- Route -----
function drawRoute(){
 if(!activeUser || !myLat) return alert("Select Customer");
 firebase.database().ref("users/"+activeUser).once("value",snap=>{
  let u=snap.val();
  if(route) map.removeControl(route);
  route=L.Routing.control({
    waypoints:[L.latLng(myLat,myLon),L.latLng(u.lat,u.lon)],
    addWaypoints:false
  }).addTo(map);
 });
}

function clearRoute(){
 if(route) map.removeControl(route);
}

</script>

</body>
</html>
