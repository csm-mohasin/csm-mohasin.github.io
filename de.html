<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Delivery Tracking</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
body{margin:0;font-family:Arial;background:#eef4ff}
header{padding:14px;font-size:20px;font-weight:700;text-align:center;background:#fff}
#map{height:70vh;margin:10px;border-radius:10px}
#box{background:#fff;margin:10px;padding:12px;border-radius:10px;font-size:18px;font-weight:600}
button{padding:10px 18px;margin:10px auto;display:block;background:#007bff;color:#fff;
border:none;border-radius:8px;font-size:16px}
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
 authDomain:"signup-d32c5.firebaseapp.com",
 projectId:"signup-d32c5",
 storageBucket:"signup-d32c5.firebasestorage.app",
 messagingSenderId:"583812949955",
 appId:"1:583812949955:web:fab1bb7be94bc1b4ab3f76",
 databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>

<body>

<header>üìç Live Delivery Tracking</header>

<div id="box">Distance: Calculating...</div>
<div id="map"></div>
<button onclick="track()">Get Live Location</button>

<script>
let map=L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let userLat,userLon,driverLat,driverLon;
let userMarker,driverMarker,route;

function calc(a,b,c,d){
 let R=6371,dLat=(c-a)*Math.PI/180,dLon=(d-b)*Math.PI/180;
 let x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
 return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

// üî• Firebase driver location listener
firebase.database().ref("liveLocation").on("value",snap=>{
 let d=snap.val(); 
 driverLat=d.lat; driverLon=d.lng;

 if(!driverMarker){
  driverMarker=L.marker([driverLat,driverLon]).addTo(map).bindPopup("Delivery Rider");
 } else {
  driverMarker.setLatLng([driverLat,driverLon]);
 }

 updateRoute();
});

// üìç Customer own location
function track(){
 navigator.geolocation.watchPosition(p=>{
   userLat=p.coords.latitude; userLon=p.coords.longitude;

   if(!userMarker){
     map.setView([userLat,userLon],14);
     userMarker=L.marker([userLat,userLon]).addTo(map).bindPopup("Your Location");
   } else {
     userMarker.setLatLng([userLat,userLon]);
   }

   updateRoute();
 });
}

// üõ£Ô∏è Show route + distance + ETA
function updateRoute(){
 if(!userLat||!driverLat) return;

 let dist=calc(driverLat,driverLon,userLat,userLon);
 let eta=Math.round((dist/30)*60);

 document.getElementById("box").innerHTML=
 `Distance: ${dist.toFixed(2)} km | ETA: ${eta} min`;

 if(route) map.removeControl(route);
 route=L.Routing.control({
   waypoints:[
     L.latLng(driverLat,driverLon),
     L.latLng(userLat,userLon)
   ],
   addWaypoints:false
 }).addTo(map);
}
</script>

</body>
</html>
