<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Live Tracker | Login Required</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
/* --- Global Styles --- */
body{margin:0;font-family:Arial;background:#eaf3ff}
header{padding:12px;font-size:20px;font-weight:bold;background:#007bff;color:white}

/* --- Login Screen Styles --- */
#login-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background: rgba(234, 243, 255, 0.95); /* Light background for focus */
    z-index: 1000;
}
.login-box {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    width: 300px;
    text-align: center;
}
.login-box input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
}
.login-box button {
    width: 100%;
    padding: 12px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 15px;
}
#login-message {
    color: #dc3545;
    margin-top: 10px;
    font-size: 14px;
}

/* --- App Content Styles (Hidden until login) --- */
#app-content {
    display: none; 
}
#map{height:75vh;margin:10px;border-radius:10px}
.card{background:white;margin:10px;padding:12px;border-radius:10px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
select, .card button{
    width:100%;padding:10px;margin-top:8px;border-radius:8px;
    border:1px solid #007bff;font-size:16px;box-sizing: border-box;
}
.card button{background:#007bff;color:white;border:none;cursor:pointer}
.card button:hover{background:#005fcc}
.popup-content strong { color: #007bff; }
.popup-content { line-height: 1.5; font-size: 14px;}
.popup-content .status-live { color: green; font-weight: bold; }
.popup-content .status-last { color: orange; font-weight: bold; }
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// --- Firebase Config ---
const firebaseConfig = {
    apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
    authDomain:"signup-d32c5.firebaseapp.com",
    projectId:"signup-d32c5",
    storageBucket:"signup-d32c5.firebasestorage.app",
    messagingSenderId:"583812949955",
    appId:"1:583812949955:web:fab1bb7be94bc1b4ab3f76",
    databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);

// üîí ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡ßç‡¶∞‡ßá‡¶°‡ßá‡¶®‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶∏ - ‡¶è‡¶á ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá!
const ADMIN_USERNAME = "csm-login";
const ADMIN_PASSWORD = "hack me";
</script>
</head>

<body>

<header>Live Tracking By CSM MOHASIN ALAM</header>

<div id="login-screen">
    <div class="login-box">
        <h2>Admin Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="attemptLogin()">Login</button>
        <p id="login-message"></p>
    </div>
</div>

<div id="app-content">
    <div class="card">
        <select id="userSelect" onchange="centerMapToUser()"> 
            <option value="">Select User ID</option>
        </select>

        <button onclick="drawRoute()">Get Direction (To User)</button>
        <button onclick="clearRoute()" style="background:#dc3545;margin-top:5px;">Clear Route</button>

        <div style="margin-top:10px;font-weight:bold">
            Distance: <span id="dist">--</span> km | ETA: <span id="eta">--</span> min (Approx)
        </div>
    </div>

    <div id="map"></div>
</div>


<script>
// ------------------------------------
// üîí ‡¶≤‡¶ó‡¶á‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
// ------------------------------------
function attemptLogin() {
    const user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;
    const msg = document.getElementById('login-message');

    if (user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
        // ‡¶∏‡¶´‡¶≤ ‡¶≤‡¶ó‡¶á‡¶®
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ
        initMapAndData(); 
    } else {
        // ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶≤‡¶ó‡¶á‡¶®
        msg.textContent = 'Invalid Username or Password!';
    }
}

// ------------------------------------
// üó∫Ô∏è ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶è‡¶¨‡¶Ç ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶≤‡¶ó‡¶á‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá)
// ------------------------------------
let map; 
let adminLat, adminLon, adminMarker, route;
let users={};
let userMarkers={};

function initMapAndData() {
    // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ
    if (!map) {
        map = L.map("map");
        
        // *** ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ Normal Layer: Google Roads/Standard Map (lyrs=m) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ***
        let normal = L.tileLayer("https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3'],
            attribution: 'Map data ¬© Google' // Google ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßç‡¶∞‡¶ø‡¶¨‡¶ø‡¶â‡¶∂‡¶®
        });
        
        // ‡¶∏‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶≤‡¶æ‡¶á‡¶ü ‡¶≠‡¶ø‡¶â ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ (lyrs=s)
        let satellite = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{subdomains:['mt0','mt1','mt2','mt3'], maxZoom: 20});
        
        normal.addTo(map);
        // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡ßá ‡¶≤‡ßá‡ßü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        L.control.layers({"Google Road Map":normal,"Satellite":satellite}).addTo(map);
        map.invalidateSize(); // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶Ü‡¶ï‡¶æ‡¶∞ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
    }

    setupAdminTracking();
    loadUserList();
    setupUserTracking();
}

// --- Map Marker Icons ---
let adminIcon = L.divIcon({
    html: `<div style="position:relative;transform:translate(-50%, -50%); width:24px;height:24px;background:green;border-radius:50%;border:2px solid white;"></div><div style="position:absolute;top:-25px;left:-20px;background:white;padding:3px 8px;border-radius:6px;border:1px solid #ccc;font-size:12px;white-space:nowrap;">Csm Mohasin Alam <img src="https://dl8.wapkizfile.info/download/c4275ed00b49e8d2f586ffbd4dc6c25f/csm-mohasin-alam+wapkizs+com/2-jpg-(csm-mohasin-alam.wapkizs.com).jpg" style="width:14px;height:14px;border-radius:50%;margin-left:3px;"></div>`
});
let userIcon = L.divIcon({
    html:`<div style="width:22px;height:22px;background:red;border-radius:50%;border:2px solid white;"></div>`
});


// Function to format time
function formatTime(isoTime) {
    if (!isoTime) return 'N/A';
    return new Date(isoTime).toLocaleString('en-GB', { 
      hour: '2-digit', minute: '2-digit', second: '2-digit', 
      day: '2-digit', month: 'short', year: 'numeric' 
    });
}

// --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ú‡¶ø‡¶™‡¶ø‡¶è‡¶∏ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ---
function setupAdminTracking() {
    navigator.geolocation.watchPosition(p=>{
        adminLat=p.coords.latitude;
        adminLon=p.coords.longitude;
        if(!map._loaded) map.setView([adminLat,adminLon],14);
        if(!adminMarker){
            adminMarker=L.marker([adminLat,adminLon],{icon:adminIcon}).addTo(map);
        }else{
            adminMarker.setLatLng([adminLat,adminLon]);
        }
    }, err => {
        console.error("Admin Location Error:", err);
    }, { enableHighAccuracy: true });
}

// --- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ---
function loadUserList() {
    firebase.database().ref("users").on("value",snap=>{
        users=snap.val()||{};
        let sel=document.getElementById("userSelect");
        sel.innerHTML=`<option value="">Select User ID</option>`;
        Object.keys(users).forEach(id=>{
            const shortId = id.substring(0, 8); 
            sel.innerHTML+=`<option value="${id}">${shortId}...</option>`;
        });
    });
}

// --- ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡ßá‡¶ï ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡¶æ ---
function setupUserTracking() {
    firebase.database().ref("users").on("child_changed", updateMarker);
    firebase.database().ref("users").on("child_added", updateMarker);
}

function updateMarker(snap){
    let id=snap.key;
    let u=snap.val();
    const lat = u.latitude || u.last_lat;
    const lon = u.longitude || u.last_lon;
    if (!lat || !lon) return;

    if(!userMarkers[id]){
        userMarkers[id]=L.marker([lat,lon],{icon:userIcon}).addTo(map);
        userMarkers[id].bindTooltip(id.substring(0, 8),{permanent:false}); 
    }else{
        userMarkers[id].setLatLng([lat,lon]);
    }

    const isLive = !!u.latitude; 
    const timeStamp = u.time || u.last_time;
    const statusClass = isLive ? 'status-live' : 'status-last';

    let popupContent = `<div class="popup-content">
                             **User ID:** ${id.substring(0, 8)}... <hr style="margin:5px 0;">
                             **Status:** <span class="${statusClass}">${isLive ? 'LIVE' : 'LAST SEEN'}</span> <br>
                             **Battery:** ${u.battery || 'N/A'} <br>
                             **Speed:** ${u.speed ? u.speed + ' km/h' : 'N/A'} <br>
                             **Network:** ${u.network || 'N/A'} <br>
                             **Last Update:** ${formatTime(timeStamp)}
                           </div>`;

    userMarkers[id].bindPopup(popupContent);
}

// üöÄ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® 
function centerMapToUser() {
    let id = document.getElementById("userSelect").value;
    if (!id) return;
    let u = users[id];
    const lat = u.latitude || u.last_lat;
    const lon = u.longitude || u.last_lon;
    if (lat && lon) {
        map.setView([lat, lon], 16);
        userMarkers[id].openPopup(); 
    }
}

// --- ‡¶∞‡¶æ‡¶â‡¶ü‡¶ø‡¶Ç ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
function drawRoute(){
    let id=document.getElementById("userSelect").value;
    if(!id){alert("Select a user ID first");return;}
    let u=users[id];
    const lat = u.latitude || u.last_lat;
    const lon = u.longitude || u.last_lon;

    if(!adminLat || !adminLon) {
        alert("Your (Admin) location is not yet available. Please wait for GPS lock.");
        return;
    }
    if(!lat || !lon) {
        alert("Location data not available for this user.");
        return;
    }

    if(route) map.removeControl(route);
    document.getElementById("dist").innerText="Calculating...";
    document.getElementById("eta").innerText="...";

    route = L.Routing.control({
        waypoints:[L.latLng(adminLat,adminLon),L.latLng(lat,lon)],
        addWaypoints:false,
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1'
        })
    }).addTo(map);

    route.on('routesfound', function(e) {
        var routes = e.routes;
        if (routes.length === 0) {
            document.getElementById("dist").innerText="--";
            document.getElementById("eta").innerText="--";
            return;
        }

        var summary = routes[0].summary;
        let distKm = summary.totalDistance / 1000;
        let etaMin = Math.round(summary.totalTime / 60); 

        document.getElementById("dist").innerText=distKm.toFixed(2);
        document.getElementById("eta").innerText=etaMin;
    });

    route.on('routingerror', function(e) {
        console.error("Routing Error:", e.error);
        document.getElementById("dist").innerText="Error!";
        document.getElementById("eta").innerText="Error!";
        alert("Routing failed! Check your connection.");
    });
}

// clear route
function clearRoute(){
    if(route) map.removeControl(route);
    document.getElementById("dist").innerText="--";
    document.getElementById("eta").innerText="--";
}
</script>

</body>
</html>
