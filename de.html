<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üöö Delivery Live View</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
body{margin:0;font-family:Arial;background:#eaf3ff}
header{padding:12px;font-size:20px;font-weight:bold;background:#007bff;color:white}
#map{height:70vh;margin:10px;border-radius:10px}
.card{background:white;margin:10px;padding:12px;border-radius:10px}
.info{font-size:16px;margin-bottom:5px}
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
 authDomain:"signup-d32c5.firebaseapp.com",
 projectId:"signup-d32c5",
 storageBucket:"signup-d32c5.firebasestorage.app",
 messagingSenderId:"583812949955",
 appId:"1:583812949955:web:fab1bb7be94bc1b4ab3f76",
 databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>

<body>

<header>üìç Live Delivery Tracking</header>

<div class="card">
<b>User:</b> <span id="uid">USER-1</span><br>
<div class="info">Distance: <span id="dist">--</span> km</div>
<div class="info">ETA: <span id="eta">--</span> mins</div>
</div>

<div id="map"></div>

<script>
// change target user id here:
const USER_ID = "USER-1";

let map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let myLat, myLon, userMarker, myMarker, route;

// get driver's own GPS
navigator.geolocation.watchPosition(p=>{
    myLat = p.coords.latitude;
    myLon = p.coords.longitude;

    if(!map._loaded) map.setView([myLat,myLon],14);

    if(!myMarker){
        myMarker = L.marker([myLat,myLon], {title:"You"}).addTo(map);
    } else {
        myMarker.setLatLng([myLat,myLon]);
    }
});

// distance function
function calc(a,b,c,d){
 var R=6371,dLat=(c-a)*Math.PI/180,dLon=(d-b)*Math.PI/180;
 var x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
 return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

// show route & ETA
function showRoute(lat,lon){
 if(route) map.removeControl(route);

 route = L.Routing.control({
   waypoints:[L.latLng(myLat,myLon),L.latLng(lat,lon)],
   addWaypoints:false,
   lineOptions:{addWaypoints:false}
 }).addTo(map);

 let d = calc(myLat,myLon,lat,lon);
 let eta = Math.round((d / 30) * 60); // 30km/h

 document.getElementById("dist").innerText = d.toFixed(2);
 document.getElementById("eta").innerText = eta;
}

// get user location from firebase
firebase.database().ref("users/" + USER_ID).on("value",snap=>{
 let u = snap.val();
 if(!u) return;

 let lat = u.lat, lon = u.lon;

 if(!userMarker){
   userMarker = L.marker([lat,lon],{title:"Customer"}).addTo(map);
 } else {
   userMarker.setLatLng([lat,lon]);
 }

 if(myLat && myLon){
   showRoute(lat,lon);
 }
});
</script>

</body>
</html>
