<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Tracking By CSM MOHASIN ALAM (Updated)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
body{margin:0;font-family:Arial;background:#eaf3ff}
header{padding:12px;font-size:20px;font-weight:bold;background:#007bff;color:white}
#map{height:75vh;margin:10px;border-radius:10px}
.card{background:white;margin:10px;padding:12px;border-radius:10px}
select,button{
Â width:100%;padding:10px;margin-top:8px;border-radius:8px;
Â border:1px solid #007bff;font-size:16px;
}
button{background:#007bff;color:white;border:none;cursor:pointer}
button:hover{background:#005fcc}
.popup-content strong { color: #007bff; }
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
Â apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
Â authDomain:"signup-d32c5.firebaseapp.com",
Â projectId:"signup-d32c5",
Â storageBucket:"signup-d32c5.firebasestorage.app",
Â messagingSenderId:"583812949955",
Â appId:"1:583812949955:web:fab1bb7be94bc1b4ab3f76",
Â databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>

<body>

<header>Live Tracking By CSM MOHASIN ALAM</header>

<div class="card">
<select id="userSelect" onchange="centerMapToUser()"> 
<option value="">Select Location</option>
</select>

<button onclick="drawRoute()">Get Direction</button>
<button onclick="clearRoute()" style="background:#dc3545;margin-top:5px;">Clear Route</button>

<div style="margin-top:10px;font-weight:bold">
Distance: <span id="dist">--</span> km | ETA: <span id="eta">--</span> min
</div>
</div>

<div id="map"></div>

<script>
// map setup
let map = L.map("map");
let normal = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
let satellite = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{subdomains:['mt0','mt1','mt2','mt3']});

normal.addTo(map);
L.control.layers({"Normal":normal,"Satellite":satellite}).addTo(map);

let adminLat, adminLon, adminMarker, route;
let users={};
let userMarkers={};

// Admin icon with verified badge
let adminIcon = L.divIcon({
Â html: `
Â  Â <div style="position:relative;transform:translate(-50%, -50%); width:24px;height:24px;background:green;border-radius:50%;border:2px solid white;"></div>
Â  Â <div style="position:absolute;top:-25px;left:-20px;background:white;padding:3px 8px;border-radius:6px;border:1px solid #ccc;font-size:12px;white-space:nowrap;">
Â  Â  Â Csm Mohasin AlamÂ 
Â  Â  Â <img src="https://dl8.wapkizfile.info/download/c4275ed00b49e8d2f586ffbd4dc6c25f/csm-mohasin-alam+wapkizs+com/2-jpg-(csm-mohasin-alam.wapkizs.com).jpg"Â 
Â  Â  Â  Â  Â  style="width:14px;height:14px;border-radius:50%;margin-left:3px;">
Â  Â </div>
Â `
});

// user icon
let userIcon = L.divIcon({
Â html:`<div style="width:22px;height:22px;background:red;border-radius:50%;border:2px solid white;"></div>`
});

// distance
function calc(a,b,c,d){
Â var R=6371,dLat=(c-a)*Math.PI/180,dLon=(d-b)*Math.PI/180;
Â var x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
Â return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

// get admin GPS
navigator.geolocation.watchPosition(p=>{
Â adminLat=p.coords.latitude;
Â adminLon=p.coords.longitude;

Â if(!map._loaded) map.setView([adminLat,adminLon],14);

Â if(!adminMarker){
Â  Â adminMarker=L.marker([adminLat,adminLon],{icon:adminIcon}).addTo(map);
Â }else{
Â  Â adminMarker.setLatLng([adminLat,adminLon]);
Â }
});

// load user list
firebase.database().ref("users").on("value",snap=>{
Â users=snap.val()||{};
Â let sel=document.getElementById("userSelect");
Â sel.innerHTML=`<option value="">Select User</option>`;
Â Object.keys(users).forEach(id=>{
Â  sel.innerHTML+=`<option value="${id}">${id}</option>`;
Â });
});

// Function to format time
function formatTime(isoTime) {
    if (!isoTime) return 'N/A';
    const date = new Date(isoTime);
    return date.toLocaleString();
}

// track each user (Child Changed Event)
firebase.database().ref("users").on("child_changed",(snap)=>{
Â let id=snap.key;
Â let u=snap.val();
Â 
Â // ğŸ“ à¦¶à§‡à¦· à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° (Live/Last Known Location Logic)
Â // à¦ªà§à¦°à¦¥à¦®à§‡ Live Location (latitude/longitude) à¦šà§‡à¦• à¦•à¦°à¦¾ à¦¹à¦¬à§‡à¥¤
Â // à¦¨à¦¾ à¦ªà§‡à¦²à§‡, last_lat/last_lon (à¦¶à§‡à¦· à¦œà¦¾à¦¨à¦¾ à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨) à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦¬à§‡à¥¤
Â const lat = u.latitude || u.last_lat;
Â const lon = u.longitude || u.last_lon;
Â 
Â // à¦¯à¦¦à¦¿ à¦•à§‹à¦¨à§‹ à¦¡à§‡à¦Ÿà¦¾à¦‡ à¦¨à¦¾ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼, à¦¤à¦¬à§‡ à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¹à¦¬à§‡ à¦¨à¦¾
Â if (!lat || !lon) return;

Â if(!userMarkers[id]){
Â  Â userMarkers[id]=L.marker([lat,lon],{icon:userIcon}).addTo(map);
Â  Â userMarkers[id].bindTooltip(id,{permanent:false});
Â }else{
Â  Â userMarkers[id].setLatLng([lat,lon]);
Â }
Â 
Â // ğŸ’¬ à¦ªà¦ªà¦†à¦ª à¦¡à§‡à¦Ÿà¦¾ à¦¤à§ˆà¦°à¦¿
Â const isLive = !!u.latitude;
Â const timeStamp = u.time || u.last_time;
Â 
Â let popupContent = `<div class="popup-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **User: ${id}** <hr style="margin:5px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Status:** ${isLive ? '<strong style="color:green;">LIVE</strong>' : '<strong style="color:orange;">LAST KNOWN</strong>'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Battery:** ${u.battery || 'N/A'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Speed:** ${u.speed ? u.speed + ' km/h' : 'N/A'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Network:** ${u.network || 'N/A'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Time:** ${formatTime(timeStamp)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â userMarkers[id].bindPopup(popupContent);
});

// ğŸš€ à¦‡à¦‰à¦œà¦¾à¦°à¦•à§‡ à¦®à§à¦¯à¦¾à¦ªà§‡ à¦¸à§‡à¦¨à§à¦Ÿà¦¾à¦°à¦¿à¦‚ à¦«à¦¾à¦‚à¦¶à¦¨
function centerMapToUser() {
Â let id = document.getElementById("userSelect").value;
Â if (!id) return;

Â let u = users[id];
Â 
Â // à¦¶à§‡à¦· à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§‡ à¦²à§à¦¯à¦¾à¦Ÿ/à¦²à¦‚ à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦£
Â const lat = u.latitude || u.last_lat;
Â const lon = u.longitude || u.last_lon;
Â 
Â if (lat && lon) {
Â  Â map.setView([lat, lon], 16); // 16 à¦ à¦œà§à¦® à¦•à¦°à¦¾ à¦¹à§Ÿà§‡à¦›à§‡
Â }
}

// draw route
function drawRoute(){
Â let id=document.getElementById("userSelect").value;
Â if(!id){alert("Select a user first");return;}

Â let u=users[id];
Â // à¦¶à§‡à¦· à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§‡ à¦²à§à¦¯à¦¾à¦Ÿ/à¦²à¦‚ à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦£
Â const lat = u.latitude || u.last_lat;
Â const lon = u.longitude || u.last_lon;
Â 
Â if(!lat || !lon) {
Â  Â alert("Location data not available for this user.");
Â  Â return;
Â }

Â if(route) map.removeControl(route);

Â route=L.Routing.control({
Â  Â waypoints:[L.latLng(adminLat,adminLon),L.latLng(lat,lon)],
Â  Â addWaypoints:false
Â }).addTo(map);

Â let d=calc(adminLat,adminLon,lat,lon);
Â let eta=Math.round((d/30)*60); // 30 km/h à¦—à¦¡à¦¼ à¦—à¦¤à¦¿ à¦§à¦°à§‡

Â document.getElementById("dist").innerText=d.toFixed(2);
Â document.getElementById("eta").innerText=eta;
}

// clear route
function clearRoute(){
Â if(route) map.removeControl(route);
Â document.getElementById("dist").innerText="--";
Â document.getElementById("eta").innerText="--";
}
</script>

</body>
</html>
