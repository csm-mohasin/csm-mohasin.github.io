<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Live Tracker | Login Required</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
/* --- Global Styles --- */
body{margin:0;font-family:Arial;background:#eaf3ff}
header{padding:12px;font-size:20px;font-weight:bold;background:#007bff;color:white}

/* --- Login Screen Styles --- */
#login-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background: rgba(234, 243, 255, 0.95); /* Light background for focus */
    z-index: 1000;
}
.login-box {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    width: 300px;
    text-align: center;
}
.login-box input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
}
.login-box button {
    width: 100%;
    padding: 12px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 15px;
}
#login-message {
    color: #dc3545;
    margin-top: 10px;
    font-size: 14px;
}

/* --- App Content Styles (Hidden until login) --- */
#app-content {
    display: none; 
}
#map{height:75vh;margin:10px;border-radius:10px}
.card{background:white;margin:10px;padding:12px;border-radius:10px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
select, .card button{
Â width:100%;padding:10px;margin-top:8px;border-radius:8px;
Â border:1px solid #007bff;font-size:16px;box-sizing: border-box;
}
.card button{background:#007bff;color:white;border:none;cursor:pointer}
.card button:hover{background:#005fcc}
.popup-content strong { color: #007bff; }
.popup-content { line-height: 1.5; font-size: 14px;}
.popup-content .status-live { color: green; font-weight: bold; }
.popup-content .status-last { color: orange; font-weight: bold; }
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// --- Firebase Config ---
const firebaseConfig = {
Â apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
Â authDomain:"signup-d32c5.firebaseapp.com",
Â projectId:"signup-d32c5",
Â storageBucket:"signup-d32c5.firebasestorage.app",
Â messagingSenderId:"583812949955",
Â appId:"1:583812949955:web:fab1bb7be94bc1b4ab3f76",
Â databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);

// ğŸ”’ à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ à¦•à§à¦°à§‡à¦¡à§‡à¦¨à¦¶à¦¿à¦¯à¦¼à¦¾à¦²à¦¸ - à¦à¦‡ à¦¦à§à¦Ÿà¦¿ à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦•à¦°à¦¤à§‡ à¦¹à¦¬à§‡!
const ADMIN_USERNAME = "mohasin_admin";
const ADMIN_PASSWORD = "super_secret_password";
</script>
</head>

<body>

<header>Live Tracking By CSM MOHASIN ALAM</header>

<div id="login-screen">
    <div class="login-box">
        <h2>Admin Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="attemptLogin()">Login</button>
        <p id="login-message"></p>
    </div>
</div>

<div id="app-content">
    <div class="card">
        <select id="userSelect" onchange="centerMapToUser()">Â 
            <option value="">Select User ID</option>
        </select>

        <button onclick="drawRoute()">Get Direction (To User)</button>
        <button onclick="clearRoute()" style="background:#dc3545;margin-top:5px;">Clear Route</button>

        <div style="margin-top:10px;font-weight:bold">
            Distance: <span id="dist">--</span> km | ETA: <span id="eta">--</span> min (Approx)
        </div>
    </div>

    <div id="map"></div>
</div>


<script>
// ------------------------------------
// ğŸ”’ à¦²à¦—à¦‡à¦¨ à¦²à¦œà¦¿à¦•
// ------------------------------------
function attemptLogin() {
    const user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;
    const msg = document.getElementById('login-message');

    if (user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
        // à¦¸à¦«à¦² à¦²à¦—à¦‡à¦¨
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        // à¦®à§à¦¯à¦¾à¦ªà§‡à¦° à¦‡à¦¨à¦¿à¦¶à¦¿à¦¯à¦¼à¦¾à¦²à¦¾à¦‡à¦œà§‡à¦¶à¦¨ à¦¶à§à¦°à§
        initMapAndData(); 
    } else {
        // à¦¬à§à¦¯à¦°à§à¦¥ à¦²à¦—à¦‡à¦¨
        msg.textContent = 'Invalid Username or Password!';
    }
}

// ------------------------------------
// ğŸ—ºï¸ à¦®à§à¦¯à¦¾à¦ª à¦à¦¬à¦‚ à¦¡à§‡à¦Ÿà¦¾ à¦²à¦œà¦¿à¦• (à¦²à¦—à¦‡à¦¨à§‡à¦° à¦ªà¦°à§‡ à¦¶à§à¦°à§ à¦¹à¦¬à§‡)
// ------------------------------------
let map; 
let adminLat, adminLon, adminMarker, route;
let users={};
let userMarkers={};

function initMapAndData() {
    // à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° à¦à¦•à¦¬à¦¾à¦° à¦®à§à¦¯à¦¾à¦ª à¦‡à¦¨à¦¿à¦¶à¦¿à¦¯à¦¼à¦¾à¦²à¦¾à¦‡à¦œ à¦•à¦°à¦¾
    if (!map) {
        map = L.map("map");
        let normal = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
        let satellite = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{subdomains:['mt0','mt1','mt2','mt3'], maxZoom: 20});
        normal.addTo(map);
        L.control.layers({"Normal":normal,"Satellite":satellite}).addTo(map);
        map.invalidateSize(); // à¦®à§à¦¯à¦¾à¦ªà§‡à¦° à¦†à¦•à¦¾à¦° à¦ à¦¿à¦• à¦•à¦°à¦¾
    }

    setupAdminTracking();
    loadUserList();
    setupUserTracking();
}

// --- Map Marker Icons ---
let adminIcon = L.divIcon({
    html: `<div style="position:relative;transform:translate(-50%, -50%); width:24px;height:24px;background:green;border-radius:50%;border:2px solid white;"></div><div style="position:absolute;top:-25px;left:-20px;background:white;padding:3px 8px;border-radius:6px;border:1px solid #ccc;font-size:12px;white-space:nowrap;">Csm Mohasin AlamÂ <img src="https://dl8.wapkizfile.info/download/c4275ed00b49e8d2f586ffbd4dc6c25f/csm-mohasin-alam+wapkizs+com/2-jpg-(csm-mohasin-alam.wapkizs.com).jpg" style="width:14px;height:14px;border-radius:50%;margin-left:3px;"></div>`
});
let userIcon = L.divIcon({
Â html:`<div style="width:22px;height:22px;background:red;border-radius:50%;border:2px solid white;"></div>`
});


// Function to format time
function formatTime(isoTime) {
Â  Â  if (!isoTime) return 'N/A';
Â  Â  return new Date(isoTime).toLocaleString('en-GB', { 
Â  Â  Â  hour: '2-digit', minute: '2-digit', second: '2-digit', 
Â  Â  Â  day: '2-digit', month: 'short', year: 'numeric' 
Â  Â  });
}

// --- à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ à¦œà¦¿à¦ªà¦¿à¦à¦¸ à¦Ÿà§à¦°à§à¦¯à¦¾à¦•à¦¿à¦‚ ---
function setupAdminTracking() {
    navigator.geolocation.watchPosition(p=>{
        adminLat=p.coords.latitude;
        adminLon=p.coords.longitude;
        if(!map._loaded) map.setView([adminLat,adminLon],14);
        if(!adminMarker){
            adminMarker=L.marker([adminLat,adminLon],{icon:adminIcon}).addTo(map);
        }else{
            adminMarker.setLatLng([adminLat,adminLon]);
        }
    }, err => {
        console.error("Admin Location Error:", err);
    }, { enableHighAccuracy: true });
}

// --- à¦‡à¦‰à¦œà¦¾à¦° à¦²à¦¿à¦¸à§à¦Ÿ à¦²à§‹à¦¡ à¦•à¦°à¦¾ ---
function loadUserList() {
    firebase.database().ref("users").on("value",snap=>{
        users=snap.val()||{};
        let sel=document.getElementById("userSelect");
        sel.innerHTML=`<option value="">Select User ID</option>`;
        Object.keys(users).forEach(id=>{
            const shortId = id.substring(0, 8); 
            sel.innerHTML+=`<option value="${id}">${shortId}...</option>`;
        });
    });
}

// --- à¦ªà§à¦°à¦¤à§à¦¯à§‡à¦• à¦‡à¦‰à¦œà¦¾à¦°à¦•à§‡ à¦Ÿà§à¦°à§à¦¯à¦¾à¦• à¦•à¦°à¦¾ ---
function setupUserTracking() {
    firebase.database().ref("users").on("child_changed", updateMarker);
    firebase.database().ref("users").on("child_added", updateMarker);
}

function updateMarker(snap){
Â let id=snap.key;
Â let u=snap.val();
Â const lat = u.latitude || u.last_lat;
Â const lon = u.longitude || u.last_lon;
Â if (!lat || !lon) return;

Â if(!userMarkers[id]){
Â  Â userMarkers[id]=L.marker([lat,lon],{icon:userIcon}).addTo(map);
Â  Â userMarkers[id].bindTooltip(id.substring(0, 8),{permanent:false}); 
Â }else{
Â  Â userMarkers[id].setLatLng([lat,lon]);
Â }
Â 
Â const isLive = !!u.latitude; 
Â const timeStamp = u.time || u.last_time;
Â const statusClass = isLive ? 'status-live' : 'status-last';
Â 
Â let popupContent = `<div class="popup-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **User ID:** ${id.substring(0, 8)}... <hr style="margin:5px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Status:** <span class="${statusClass}">${isLive ? 'LIVE' : 'LAST SEEN'}</span> <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Battery:** ${u.battery || 'N/A'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Speed:** ${u.speed ? u.speed + ' km/h' : 'N/A'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Network:** ${u.network || 'N/A'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Last Update:** ${formatTime(timeStamp)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â userMarkers[id].bindPopup(popupContent);
}

// ğŸš€ à¦‡à¦‰à¦œà¦¾à¦°à¦•à§‡ à¦®à§à¦¯à¦¾à¦ªà§‡ à¦¸à§‡à¦¨à§à¦Ÿà¦¾à¦°à¦¿à¦‚ à¦«à¦¾à¦‚à¦¶à¦¨ 
function centerMapToUser() {
Â let id = document.getElementById("userSelect").value;
Â if (!id) return;
Â let u = users[id];
Â const lat = u.latitude || u.last_lat;
Â const lon = u.longitude || u.last_lon;
Â if (lat && lon) {
Â  Â map.setView([lat, lon], 16);
Â  Â userMarkers[id].openPopup(); 
Â }
}

// --- à¦°à¦¾à¦‰à¦Ÿà¦¿à¦‚ à¦«à¦¾à¦‚à¦¶à¦¨ ---
function drawRoute(){
Â let id=document.getElementById("userSelect").value;
Â if(!id){alert("Select a user ID first");return;}
Â let u=users[id];
Â const lat = u.latitude || u.last_lat;
Â const lon = u.longitude || u.last_lon;
Â 
Â if(!adminLat || !adminLon) {
Â  Â alert("Your (Admin) location is not yet available. Please wait for GPS lock.");
Â  Â return;
Â }
Â if(!lat || !lon) {
Â  Â alert("Location data not available for this user.");
Â  Â return;
Â }

Â if(route) map.removeControl(route);
Â document.getElementById("dist").innerText="Calculating...";
Â document.getElementById("eta").innerText="...";

Â route = L.Routing.control({
Â  Â waypoints:[L.latLng(adminLat,adminLon),L.latLng(lat,lon)],
Â  Â addWaypoints:false,
Â  Â router: L.Routing.osrmv1({
Â  Â  Â serviceUrl: 'https://router.project-osrm.org/route/v1'
Â  Â })
Â }).addTo(map);

Â route.on('routesfound', function(e) {
Â  Â var routes = e.routes;
Â  Â if (routes.length === 0) {
Â  Â  Â document.getElementById("dist").innerText="--";
Â  Â  Â document.getElementById("eta").innerText="--";
Â  Â  Â return;
Â  Â }
Â  Â 
Â  Â var summary = routes[0].summary;
Â  Â let distKm = summary.totalDistance / 1000;
Â  Â let etaMin = Math.round(summary.totalTime / 60); 

Â  Â document.getElementById("dist").innerText=distKm.toFixed(2);
Â  Â document.getElementById("eta").innerText=etaMin;
Â });

Â route.on('routingerror', function(e) {
Â  Â console.error("Routing Error:", e.error);
Â  Â document.getElementById("dist").innerText="Error!";
Â  Â document.getElementById("eta").innerText="Error!";
Â  Â alert("Routing failed! Check your connection.");
Â });
}

// clear route
function clearRoute(){
Â if(route) map.removeControl(route);
Â document.getElementById("dist").innerText="--";
Â document.getElementById("eta").innerText="--";
}
</script>

</body>
</html>
