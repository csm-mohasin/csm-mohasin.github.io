<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Tracking By CSM MOHASIN ALAM</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
body{margin:0;font-family:Arial;background:#eaf3ff}
header{padding:12px;font-size:20px;font-weight:bold;background:#007bff;color:white}
#map{height:75vh;margin:10px;border-radius:10px}
.card{background:white;margin:10px;padding:12px;border-radius:10px}
select,button{
 width:100%;padding:10px;margin-top:8px;border-radius:8px;
 border:1px solid #007bff;font-size:16px;
}
button{background:#007bff;color:white;border:none;cursor:pointer}
button:hover{background:#005fcc}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
 authDomain:"signup-d32c5.firebaseapp.com",
 projectId:"signup-d32c5",
 storageBucket:"signup-d32c5.firebasestorage.app",
 messagingSenderId:"583812949955",
 appId:"1:583812949955:web:fab1bb7be94bc1b4ab3f76",
 databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>

<body>

<header>Live Tracking By CSM MOHASIN ALAM</header>

<div class="card">
<select id="userSelect">
<option value="">Select Location</option>
</select>

<button onclick="drawRoute()">Get Direction</button>
<button onclick="clearRoute()" style="background:#dc3545;margin-top:5px;">Clear Route</button>

<div style="margin-top:10px;font-weight:bold">
Distance: <span id="dist">--</span> km | ETA: <span id="eta">--</span> min
</div>
</div>

<div id="map"></div>

<script>
// map setup
let map = L.map("map");
let normal = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
let satellite = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{subdomains:['mt0','mt1','mt2','mt3']});

normal.addTo(map);
L.control.layers({"Normal":normal,"Satellite":satellite}).addTo(map);

let adminLat, adminLon, adminMarker, route;
let users={};
let userMarkers={};

// Admin icon with verified badge
let adminIcon = L.divIcon({
 html: `
   <div style="position:relative;transform:translate(-50%, -50%); width:24px;height:24px;background:green;border-radius:50%;border:2px solid white;"></div>
   <div style="position:absolute;top:-25px;left:-20px;background:white;padding:3px 8px;border-radius:6px;border:1px solid #ccc;font-size:12px;white-space:nowrap;">
     Csm Mohasin Alam 
     <img src="https://dl8.wapkizfile.info/download/c4275ed00b49e8d2f586ffbd4dc6c25f/csm-mohasin-alam+wapkizs+com/2-jpg-(csm-mohasin-alam.wapkizs.com).jpg" 
          style="width:14px;height:14px;border-radius:50%;margin-left:3px;">
   </div>
 `
});

// user icon
let userIcon = L.divIcon({
 html:`<div style="width:22px;height:22px;background:red;border-radius:50%;border:2px solid white;"></div>`
});

// distance
function calc(a,b,c,d){
 var R=6371,dLat=(c-a)*Math.PI/180,dLon=(d-b)*Math.PI/180;
 var x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
 return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

// get admin GPS
navigator.geolocation.watchPosition(p=>{
 adminLat=p.coords.latitude;
 adminLon=p.coords.longitude;

 if(!map._loaded) map.setView([adminLat,adminLon],14);

 if(!adminMarker){
   adminMarker=L.marker([adminLat,adminLon],{icon:adminIcon}).addTo(map);
 }else{
   adminMarker.setLatLng([adminLat,adminLon]);
 }
});

// load user list
firebase.database().ref("users").on("value",snap=>{
 users=snap.val()||{};
 let sel=document.getElementById("userSelect");
 sel.innerHTML=`<option value="">Select User</option>`;
 Object.keys(users).forEach(id=>{
  sel.innerHTML+=`<option value="${id}">${id}</option>`;
 });
});

// track each user
firebase.database().ref("users").on("child_changed",(snap)=>{
 let id=snap.key;
 let u=snap.val();

 if(!userMarkers[id]){
   userMarkers[id]=L.marker([u.lat,u.lon],{icon:userIcon}).addTo(map);
   userMarkers[id].bindTooltip(id,{permanent:false});
 }else{
   userMarkers[id].setLatLng([u.lat,u.lon]);
 }
});

// draw route
function drawRoute(){
 let id=document.getElementById("userSelect").value;
 if(!id){alert("Select a user first");return;}

 let u=users[id];
 if(route) map.removeControl(route);

 route=L.Routing.control({
   waypoints:[L.latLng(adminLat,adminLon),L.latLng(u.lat,u.lon)],
   addWaypoints:false
 }).addTo(map);

 let d=calc(adminLat,adminLon,u.lat,u.lon);
 let eta=Math.round((d/30)*60);

 document.getElementById("dist").innerText=d.toFixed(2);
 document.getElementById("eta").innerText=eta;
}

// clear route
function clearRoute(){
 if(route) map.removeControl(route);
 document.getElementById("dist").innerText="--";
 document.getElementById("eta").innerText="--";
}
</script>

</body>
</html>
