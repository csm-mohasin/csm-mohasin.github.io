<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üöö Multi User Delivery Tracking</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
body{margin:0;font-family:Arial;background:#eaf3ff}
header{padding:12px;font-size:20px;font-weight:bold;background:#007bff;color:white}
#map{height:65vh;margin:10px;border-radius:10px}
.card{background:white;margin:10px;padding:12px;border-radius:10px}
.info{font-size:16px;margin-bottom:6px}
button,select{
width:90%;margin:8px auto;display:block;
padding:12px;font-size:16px;border:none;border-radius:8px;cursor:pointer
}
button{background:#007bff;color:white}
#clearRouteBtn{background:#ff3b30}
select{background:white;border:1px solid #aaa}
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
 authDomain:"signup-d32c5.firebaseapp.com",
 projectId:"signup-d32c5",
 storageBucket:"signup-d32c5.firebasestorage.app",
 messagingSenderId:"583812949955",
 appId:"1:583812949955:web:fab1bb7be94bc1b4ab3f76",
 databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>

<body>

<header>üìç Multi-User Delivery Tracking</header>

<div class="card">
<div class="info">Distance: <span id="dist">--</span> km</div>
<div class="info">ETA: <span id="eta">--</span> mins</div>
</div>

<select id="userSelect">
<option value="">Select Customer</option>
</select>

<div id="map"></div>

<button id="routeBtn">Show Route üöóüìç</button>
<button id="clearRouteBtn">Clear Route ‚ùå</button>

<script>
// Marker icons
const greenIcon = L.icon({
    iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
    shadowUrl:"https://unpkg.com/leaflet/dist/images/marker-shadow.png",
    iconSize:[25,41],iconAnchor:[12,41]
});
const redIcon = L.icon({
    iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
    shadowUrl:"https://unpkg.com/leaflet/dist/images/marker-shadow.png",
    iconSize:[25,41],iconAnchor:[12,41]
});

// Map layers
let normal = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
let satellite = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
        subdomains:['mt0','mt1','mt2','mt3']
});

let map = L.map("map",{layers:[satellite]});
L.control.layers({"üåç Normal":normal,"üõ∞ Satellite":satellite}).addTo(map);

let myLat,myLon,myMarker,route;
let customerMarkers = {};
let selectedUser = "";

// Driver location
navigator.geolocation.watchPosition(pos=>{
    myLat = pos.coords.latitude;
    myLon = pos.coords.longitude;

    if(!map._loaded) map.setView([myLat,myLon],14);

    if(!myMarker){
        myMarker = L.marker([myLat,myLon],{icon:greenIcon,title:"Rider"}).addTo(map);
    } else myMarker.setLatLng([myLat,myLon]);
});

// Distance function
function calc(a,b,c,d){
 let R=6371,dLat=(c-a)*Math.PI/180,dLon=(d-b)*Math.PI/180;
 let x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
 return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

// Draw Route
function drawRoute(lat,lon){
 if(route) map.removeControl(route);
 route=L.Routing.control({
     waypoints:[L.latLng(myLat,myLon),L.latLng(lat,lon)],
     addWaypoints:false
 }).addTo(map);

 let d=calc(myLat,myLon,lat,lon);
 document.getElementById("dist").innerText=d.toFixed(2);
 document.getElementById("eta").innerText=Math.round((d/30)*60);
}

// Load all customers on map
firebase.database().ref("users").on("value", snap=>{
 let list = snap.val();
 let dropdown = document.getElementById("userSelect");
 dropdown.innerHTML="<option value=''>Select Customer</option>";

 for(let id in list){
     let lat=list[id].lat, lon=list[id].lon;

     dropdown.innerHTML+=`<option value="${id}">${id}</option>`;

     if(!customerMarkers[id])
         customerMarkers[id]=L.marker([lat,lon],{icon:redIcon,title:id}).addTo(map);
     else
         customerMarkers[id].setLatLng([lat,lon]);
 }
});

// Dropdown selection
document.getElementById("userSelect").onchange = function(){
 selectedUser=this.value;
};

// Button: Show Route
document.getElementById("routeBtn").onclick = ()=>{
 if(!selectedUser) return alert("Select customer first!");

 firebase.database().ref("users/"+selectedUser).once("value",snap=>{
   let u=snap.val();
   if(!u) return;
   drawRoute(u.lat, u.lon);
 });
};

// Button: Clear route
document.getElementById("clearRouteBtn").onclick=()=>{
 if(route) map.removeControl(route);
};

</script>
</body>
</html>
