<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Live Tracker | CSM MOHASIN ALAM</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
body{margin:0;font-family:Arial;background:#eaf3ff}
header{padding:12px;font-size:20px;font-weight:bold;background:#007bff;color:white}
#map{height:75vh;margin:10px;border-radius:10px}
.card{background:white;margin:10px;padding:12px;border-radius:10px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
select,button{
Â width:100%;padding:10px;margin-top:8px;border-radius:8px;
Â border:1px solid #007bff;font-size:16px;box-sizing: border-box;
}
button{background:#007bff;color:white;border:none;cursor:pointer}
button:hover{background:#005fcc}
.popup-content strong { color: #007bff; }
.popup-content { line-height: 1.5; font-size: 14px;}
.popup-content .status-live { color: green; font-weight: bold; }
.popup-content .status-last { color: orange; font-weight: bold; }
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// --- Firebase Config ---
const firebaseConfig = {
Â apiKey:"AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
Â authDomain:"signup-d32c5.firebaseapp.com",
Â projectId:"signup-d32c5",
Â storageBucket:"signup-d32c5.firebasestorage.app",
Â messagingSenderId:"583812949955",
Â appId:"1:583812949955:web:fab1bb7be94bc1b4ab3f76",
Â databaseURL:"https://signup-d32c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>

<body>

<header>Live Tracking By CSM MOHASIN ALAM</header>

<div class="card">
<select id="userSelect" onchange="centerMapToUser()">Â 
<option value="">Select User ID</option>
</select>

<button onclick="drawRoute()">Get Direction (To User)</button>
<button onclick="clearRoute()" style="background:#dc3545;margin-top:5px;">Clear Route</button>

<div style="margin-top:10px;font-weight:bold">
Distance: <span id="dist">--</span> km | ETA: <span id="eta">--</span> min (Approx)
</div>
</div>

<div id="map"></div>

<script>
// --- Map Setup ---
let map = L.map("map");
let normal = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
let satellite = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{subdomains:['mt0','mt1','mt2','mt3'], maxZoom: 20});

normal.addTo(map);
L.control.layers({"Normal":normal,"Satellite":satellite}).addTo(map);

let adminLat, adminLon, adminMarker, route;
let users={};
let userMarkers={};

// Admin icon with verified badge (No Change)
let adminIcon = L.divIcon({
Â html: `
Â  Â <div style="position:relative;transform:translate(-50%, -50%); width:24px;height:24px;background:green;border-radius:50%;border:2px solid white;"></div>
Â  Â <div style="position:absolute;top:-25px;left:-20px;background:white;padding:3px 8px;border-radius:6px;border:1px solid #ccc;font-size:12px;white-space:nowrap;">
Â  Â  Â Csm Mohasin AlamÂ 
Â  Â  Â <img src="https://dl8.wapkizfile.info/download/c4275ed00b49e8d2f586ffbd4dc6c25f/csm-mohasin-alam+wapkizs+com/2-jpg-(csm-mohasin-alam.wapkizs.com).jpg"Â 
Â  Â  Â  Â  Â  style="width:14px;height:14px;border-radius:50%;margin-left:3px;">
Â  Â </div>
Â `
});

// user icon (No Change)
let userIcon = L.divIcon({
Â html:`<div style="width:22px;height:22px;background:red;border-radius:50%;border:2px solid white;"></div>`
});

// distance calculation (No Change)
function calc(a,b,c,d){
Â var R=6371,dLat=(c-a)*Math.PI/180,dLon=(d-b)*Math.PI/180;
Â var x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
Â return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

// Function to format time
function formatTime(isoTime) {
Â  Â  if (!isoTime) return 'N/A';
Â  Â  // BD Time Zone
Â  Â  return new Date(isoTime).toLocaleString('en-GB', { 
Â  Â  Â  hour: '2-digit', minute: '2-digit', second: '2-digit', 
Â  Â  Â  day: '2-digit', month: 'short', year: 'numeric' 
Â  Â  });
}

// --- à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ à¦œà¦¿à¦ªà¦¿à¦à¦¸ à¦Ÿà§à¦°à§à¦¯à¦¾à¦•à¦¿à¦‚ (No Change) ---
navigator.geolocation.watchPosition(p=>{
Â adminLat=p.coords.latitude;
Â adminLon=p.coords.longitude;

Â if(!map._loaded) map.setView([adminLat,adminLon],14);

Â if(!adminMarker){
Â  Â adminMarker=L.marker([adminLat,adminLon],{icon:adminIcon}).addTo(map);
Â }else{
Â  Â adminMarker.setLatLng([adminLat,adminLon]);
Â }
});

// --- à¦‡à¦‰à¦œà¦¾à¦° à¦²à¦¿à¦¸à§à¦Ÿ à¦²à§‹à¦¡ à¦•à¦°à¦¾ (Changed: Child Added & All Users) ---
firebase.database().ref("users").on("value",snap=>{
Â users=snap.val()||{};
Â let sel=document.getElementById("userSelect");
Â sel.innerHTML=`<option value="">Select User ID</option>`;
Â Object.keys(users).forEach(id=>{
Â  Â // à¦‡à¦‰à¦¨à¦¿à¦• à¦†à¦‡à¦¡à¦¿ à¦–à§à¦¬ à¦²à¦®à§à¦¬à¦¾ à¦¹à¦¯à¦¼, à¦¤à¦¾à¦‡ à¦ªà¦ªà¦†à¦ªà§‡ à¦¦à§‡à¦–à¦¾à¦¨à§‹à¦° à¦œà¦¨à§à¦¯ à¦ªà§à¦°à¦¥à¦® 8à¦Ÿà¦¿ à¦…à¦•à§à¦·à¦° à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦²à§‹
Â  Â const shortId = id.substring(0, 8); 
Â  Â sel.innerHTML+=`<option value="${id}">${shortId}...</option>`;
Â });
});

// --- à¦ªà§à¦°à¦¤à§à¦¯à§‡à¦• à¦‡à¦‰à¦œà¦¾à¦°à¦•à§‡ à¦Ÿà§à¦°à§à¦¯à¦¾à¦• à¦•à¦°à¦¾ (Child Added/Changed/Removed) ---
firebase.database().ref("users").on("child_changed", updateMarker);
firebase.database().ref("users").on("child_added", updateMarker);

function updateMarker(snap){
Â let id=snap.key;
Â let u=snap.val();
Â 
Â // âœ… à¦¨à¦¤à§à¦¨ à¦²à¦œà¦¿à¦•: à¦²à¦¾à¦‡à¦­ à¦²à§‹à¦•à§‡à¦¶à¦¨ à¦¨à¦¾ à¦¥à¦¾à¦•à¦²à§‡ last_lat/last_lon à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§‹
Â const lat = u.latitude || u.last_lat;
Â const lon = u.longitude || u.last_lon;
Â 
Â // à¦¡à§‡à¦Ÿà¦¾ à¦¨à¦¾ à¦¥à¦¾à¦•à¦²à§‡, à¦•à¦¿à¦›à§ à¦•à¦°à¦¬à§‡ à¦¨à¦¾
Â if (!lat || !lon) return;

Â if(!userMarkers[id]){
Â  Â userMarkers[id]=L.marker([lat,lon],{icon:userIcon}).addTo(map);
Â  Â // à¦Ÿà§à¦²à¦Ÿà¦¿à¦ªà§‡ à¦†à¦‡à¦¡à¦¿-à¦à¦° à¦ªà§à¦°à¦¥à¦® à§® à¦…à¦•à§à¦·à¦° à¦¦à§‡à¦–à¦¾à¦¨à§‹ à¦¹à¦¯à¦¼à§‡à¦›à§‡
Â  Â userMarkers[id].bindTooltip(id.substring(0, 8),{permanent:false}); 
Â }else{
Â  Â // à¦®à¦¾à¦°à§à¦•à¦¾à¦° à¦®à§à¦­ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡
Â  Â userMarkers[id].setLatLng([lat,lon]);
Â }
Â 
Â // ğŸ’¬ à¦ªà¦ªà¦†à¦ª à¦¡à§‡à¦Ÿà¦¾ à¦¤à§ˆà¦°à¦¿ (Updated with all data)
Â const isLive = !!u.latitude; // latitude property à¦¥à¦¾à¦•à¦²à§‡ LIVE
Â const timeStamp = u.time || u.last_time;
Â const statusClass = isLive ? 'status-live' : 'status-last';
Â 
Â let popupContent = `<div class="popup-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **User ID:** ${id.substring(0, 8)}... <hr style="margin:5px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Status:** <span class="${statusClass}">${isLive ? 'LIVE' : 'LAST SEEN'}</span> <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Battery:** ${u.battery || 'N/A'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Speed:** ${u.speed ? u.speed + ' km/h' : 'N/A'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Network:** ${u.network || 'N/A'} <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Last Update:** ${formatTime(timeStamp)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â userMarkers[id].bindPopup(popupContent);
}

// ğŸš€ à¦‡à¦‰à¦œà¦¾à¦°à¦•à§‡ à¦®à§à¦¯à¦¾à¦ªà§‡ à¦¸à§‡à¦¨à§à¦Ÿà¦¾à¦°à¦¿à¦‚ à¦«à¦¾à¦‚à¦¶à¦¨ (Updated with new logic)
function centerMapToUser() {
Â let id = document.getElementById("userSelect").value;
Â if (!id) return;

Â let u = users[id];
Â 
Â // à¦²à¦¾à¦‡à¦­ à¦¬à¦¾ à¦¶à§‡à¦· à¦œà¦¾à¦¨à¦¾ à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°
Â const lat = u.latitude || u.last_lat;
Â const lon = u.longitude || u.last_lon;
Â 
Â if (lat && lon) {
Â  Â map.setView([lat, lon], 16);
Â  Â userMarkers[id].openPopup(); // à¦¸à§‡à¦¨à§à¦Ÿà¦¾à¦°à¦¿à¦‚-à¦à¦° à¦ªà¦° à¦ªà¦ªà¦†à¦ª à¦“à¦ªà§‡à¦¨ à¦¹à¦¬à§‡
Â }
}

// draw route (No Change)
function drawRoute(){
Â let id=document.getElementById("userSelect").value;
Â if(!id){alert("Select a user ID first");return;}

Â let u=users[id];
Â // à¦²à¦¾à¦‡à¦­ à¦¬à¦¾ à¦¶à§‡à¦· à¦œà¦¾à¦¨à¦¾ à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°
Â const lat = u.latitude || u.last_lat;
Â const lon = u.longitude || u.last_lon;
Â 
Â if(!adminLat || !adminLon) {
Â  Â alert("Your location is not yet available.");
Â  Â return;
Â }

Â if(!lat || !lon) {
Â  Â alert("Location data not available for this user.");
Â  Â return;
Â }

Â if(route) map.removeControl(route);

Â route=L.Routing.control({
Â  Â waypoints:[L.latLng(adminLat,adminLon),L.latLng(lat,lon)],
Â  Â addWaypoints:false,
Â  Â router: L.Routing.osrmv1({
Â  Â  Â serviceUrl: 'https://router.project-osrm.org/route/v1'
Â  Â })
Â }).addTo(map);

Â route.on('routesfound', function(e) {
Â  Â var routes = e.routes;
Â  Â var summary = routes[0].summary;
Â  Â 
Â  Â // à¦¦à§‚à¦°à¦¤à§à¦¬ à¦•à¦¿à¦²à§‹à¦®à¦¿à¦Ÿà¦¾à¦°-à¦
Â  Â let distKm = summary.totalDistance / 1000;
Â  Â 
Â  Â // ETA à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡ (à¦¸à¦®à¦¯à¦¼ à¦¸à§‡à¦•à§‡à¦¨à§à¦¡à§‡ à¦¥à¦¾à¦•à§‡)
Â  Â // OSRM-à¦à¦° à¦¸à¦®à¦¯à¦¼ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡, à¦¯à¦¾ à¦¬à§‡à¦¶à¦¿ à¦¨à¦¿à¦°à§à¦­à§à¦²
Â  Â let etaMin = Math.round(summary.totalTime / 60); 

Â  Â document.getElementById("dist").innerText=distKm.toFixed(2);
Â  Â document.getElementById("eta").innerText=etaMin;
Â });
}

// clear route (No Change)
function clearRoute(){
Â if(route) map.removeControl(route);
Â document.getElementById("dist").innerText="--";
Â document.getElementById("eta").innerText="--";
}
</script>

</body>
</html>
