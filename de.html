<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸš€ Pro Delivery Dashboard â€” Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
body { margin:0; background:#eef5ff; font-family:Arial; }
header { padding:15px; text-align:center; font-size:20px; font-weight:bold; background:white; }
#userBox { background:white; margin:10px; padding:10px; border-radius:10px; }
.userRow { padding:10px; border-bottom:1px solid #ddd; cursor:pointer; }
.userRow:hover { background:#f5f9ff; }
.btn {
  padding:6px 12px; border-radius:8px; border:0;
  margin-left:5px; cursor:pointer;
}
.navBtn { background:#1976ff; color:white; }
.centerBtn { background:#eee; }
#map { height:450px; width:100%; }
#infoBar {
  background:white; padding:8px; text-align:center;
  font-size:16px; margin-top:5px;
}
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCsGBSRCHVUhXQZ5DNMEZWgQWk1gxMF1E4",
  authDomain: "signup-d32c5.firebaseapp.com",
  databaseURL: "https://signup-d32c5-default-rtdb.firebaseio.com/",
  projectId: "signup-d32c5",
  storageBucket: "signup-d32c5.firebasestorage.app",
  messagingSenderId: "583812949955",
  appId: "1:583812949955:web:fab1bb7be94bc1b4ab3f76"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>

<body>

<header>ðŸš€ Pro Delivery Dashboard â€” Live</header>

<div id="userBox">
  <h3>Live users</h3>
  <div id="usersList">Loading...</div>
</div>

<div id="infoBar">Distance: -- km | ETA: -- mins</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
var map = L.map('map').setView([23.8103, 90.4125], 11);
var markers = {};
var routingControl, myLat, myLon;

// Map layers
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Delivery person live location
navigator.geolocation.watchPosition(p=>{
  myLat = p.coords.latitude;
  myLon = p.coords.longitude;
});

// Haversine Distance
function getDist(a,b,c,d){
  var R=6371;
  var dLat=(c-a)*Math.PI/180; var dLon=(d-b)*Math.PI/180;
  var x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*(Math.sin(dLon/2)**2);
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// Load User List + Map markers
firebase.database().ref("users").on("value",snap=>{
  var data = snap.val(); 
  var list = ""; 
  for (let id in data){
    let u = data[id];
    let lat = u.lat, lon = u.lon;

    // Marker add/update
    if (!markers[id])
      markers[id] = L.marker([lat, lon]).addTo(map);
    else
      markers[id].setLatLng([lat, lon]);

    list += `<div class="userRow" onclick="focusUser('${id}')">
      <b>${id}</b><br>
      ${u.device} â€¢ ${u.area}<br>Battery: ${u.battery}%<br>
      <button class="btn navBtn" onclick="navigate('${id}',${lat},${lon})">Navigate</button>
      <button class="btn centerBtn" onclick="focusUser('${id}')">Center</button>
    </div>`;
  }
  document.getElementById("usersList").innerHTML=list;
});

function focusUser(id){
  let m = markers[id];
  if(m){ map.setView(m.getLatLng(), 14); }
}

function navigate(id,lat,lon){
  if(!myLat||!myLon) return alert("Turn on GPS");
  if(routingControl) map.removeControl(routingControl);

  routingControl = L.Routing.control({
    waypoints: [L.latLng(myLat,myLon), L.latLng(lat,lon)],
    addWaypoints:false, draggableWaypoints:false
  }).addTo(map);

  let dist = getDist(myLat,myLon,lat,lon).toFixed(2);
  let eta = (dist/0.4*60).toFixed(0);

  document.getElementById("infoBar").innerText =
    `Distance: ${dist} km | ETA: ${eta} mins`;
}
</script>

</body>
</html>
